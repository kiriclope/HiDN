#+STARTUP: fold
#+PROPERTY: header-args:ipython :results both :exports both :async yes :session pca :kernel torch :output-dir ./figures/overlaps :file (lc/org-babel-tangle-figure-filename)

* Notebook Settings

#+begin_src ipython
import matplotlib.pyplot
#+end_src

#+RESULTS:


#+begin_src ipython
%load_ext autoreload
%autoreload 2
%reload_ext autoreload

%run /home/leon/dual_task/dual_data/notebooks/setup.py
# %config InlineBackend.figure_format = 'png'
#+end_src

#+RESULTS:
: The autoreload extension is already loaded. To reload it, use:
:   %reload_ext autoreload
: Python exe
: /home/leon/mambaforge/envs/torch/bin/python

* Imports

#+begin_src ipython
  from sklearn.exceptions import ConvergenceWarning
  warnings.filterwarnings("ignore")
  import traceback

  import sys
  sys.path.insert(0, '/home/leon/dual_task/dual_data/')

  import os
  if not sys.warnoptions:
    warnings.simplefilter("ignore")
    os.environ["PYTHONWARNINGS"] = "ignore"

  import pickle as pkl
  import numpy as np
  import matplotlib.pyplot as plt
  import pandas as pd
  import seaborn as sns

  from time import perf_counter

  from sklearn.base import clone
  from sklearn.metrics import make_scorer, roc_auc_score
  from sklearn.preprocessing import StandardScaler, RobustScaler
  from sklearn.model_selection import RepeatedStratifiedKFold, LeaveOneOut, StratifiedKFold

  from src.common.plot_utils import add_vlines, add_vdashed
  from src.common.options import set_options
  from src.stats.bootstrap import my_boots_ci
  from src.common.get_data import get_X_y_days, get_X_y_S1_S2
  from src.preprocess.helpers import avg_epochs
  from src.decode.bump import circcvl
  from src.torch.classificationCV import ClassificationCV
  from src.torch.classify import get_classification
#+end_src

#+RESULTS:

* Helpers

#+begin_src ipython
def pad_with_nans(array, target_shape):
    result = np.full(target_shape, np.nan)  # Create an array filled with NaNs
    print(result.shape)
    slices = tuple(slice(0, min(dim, target)) for dim, target in zip(array.shape, target_shape))
    result[slices] = array[slices]
    return result
#+end_src

#+RESULTS:

#+begin_src ipython :tangle ../src/torch/utils.py
  import numpy as np

  def safe_roc_auc_score(y_true, y_score):
      y_true = np.asarray(y_true)
      if len(np.unique(y_true)) == 1:
          return 0.5  # return np.nan where the score cannot be calculated
      return roc_auc_score(y_true, y_score)

  def safe_f1_score(y_true, y_score):
      y_true = np.asarray(y_true)
      if len(np.unique(y_true)) == 1:
          return 0.5  # return np.nan where the score cannot be calculated
      return f1_score(y_true, y_score, average='weighted')
      #+end_src

#+RESULTS:

#+begin_src ipython :tangle ../src/torch/utils.py
  def rescale_coefs(model, coefs, bias):

          try:
                  means = model.named_steps["scaler"].mean_
                  scales = model.named_steps["scaler"].scale_

                  # Rescale the coefficients
                  rescaled_coefs = np.true_divide(coefs, scales)

                  # Adjust the intercept
                  rescaled_bias = bias - np.sum(rescaled_coefs * means)

                  return rescaled_coefs, rescaled_bias
          except:
                  return coefs, bias

#+end_src

#+RESULTS:

#+begin_src ipython :tangle ../src/torch/utils.py
  from scipy.stats import bootstrap

  def get_bootstrap_ci(data, statistic=np.mean, confidence_level=0.95, n_resamples=1000, random_state=None):
      result = bootstrap((data,), statistic)
      ci_lower, ci_upper = result.confidence_interval
      return np.array([ci_lower, ci_upper])
#+end_src

#+RESULTS:

#+begin_src ipython :tangle ../src/torch/utils.py
  def convert_seconds(seconds):
      h = seconds // 3600
      m = (seconds % 3600) // 60
      s = seconds % 60
      return h, m, s
#+end_src

#+RESULTS:

#+begin_src ipython :tangle ../src/torch/utils.py
  import pickle as pkl

  def pkl_save(obj, name, path="."):
      os.makedirs(path, exist_ok=True)
      destination = path + "/" + name + ".pkl"
      print("saving to", destination)
      pkl.dump(obj, open(destination, "wb"))


  def pkl_load(name, path="."):
      source = path + "/" + name + '.pkl'
      print('loading from', source)
      return pkl.load(open( source, "rb"))

#+end_src

#+RESULTS:

#+begin_src ipython
def overlaps_scorer(estimator, X_test, y_test, IF_SIGN=0):
    try:
        coef = estimator.named_steps["model"].coef_.flatten()
        clf = estimator #.named_steps["model"]
    except:
        coef = estimator.best_estimator_.named_steps["model"].coef_.flatten()
        clf = estimator.best_estimator_.named_steps["model"]

    norm_w = np.linalg.norm(coef) + 1e-6

    # try:
    #     X_test = clf.named_steps["scaler"].transform(X_test)
    # except:
    #     pass

    # try:
    #     X_test = clf.named_steps["pca"].transform(X_test)
    # except:
    #     pass

    if IF_SIGN:
        dot_product = (2*y_test -1) * np.dot(X_test, coef) / norm_w # / X_test.shape[1] * 1000
        # dot_product = (2*y_test -1) * clf.named_steps["model"].decision_function(X_test)
        # dot_product = (2*y_test -1) * clf.decision_function(X_test) / norm_w
    else:
        # dot_product = clf.decision_function(X_test) / norm_w
        # dot_product = clf.named_steps["model"].decision_function(X_test)
        dot_product = np.dot(X_test, coef) / norm_w # / X_test.shape[1] * 1000

    return np.nanmean(dot_product)
#+end_src

#+RESULTS:

* Parameters

#+begin_src ipython
old_mice = ['ChRM04','JawsM15', 'JawsM18', 'ACCM03', 'ACCM04']
Jaws_mice = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18']

mice = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23', 'ACCM03', 'ACCM04']
# mice = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23']
# mice = ['JawsM15', 'JawsM18', 'ChRM04']

tasks = ['DPA'] # all

kwargs = {
   'mice': mice,
   'tasks': tasks,
   'mouse': mice[0], 'laser': 0,
   'trials': '', 'reload': 1, 'data_type': 'dF',
   'prescreen': None, 'pval': 0.05,
   'preprocess': False, 'scaler_BL': 'robust',
   'avg_noise':True, 'unit_var_BL': True,
   'random_state': None, 'T_WINDOW': 0.0,
   'l1_ratio': 0.95,
   'n_comp': 5, 'pca': 'pca',
   'scaler': None,
   'bootstrap': 1, 'n_boots': 128,
   'n_splits': 5, 'n_repeats': 10,
   'class_weight': 0,
   'multilabel': 0,
   'mne_estimator':'generalizing', # sliding or generalizing
   'n_jobs': 64,
}

# kwargs['days'] = ['first', 'middle', 'last']
kwargs['days'] = ['first', 'last']
# kwargs['days'] = 'all'
options = set_options(**kwargs)
options['cv_B'] = False
#+end_src

#+RESULTS:

* Decoding vs days
** utils

#+begin_src ipython
def decode_axis(model, **options):
    new_mice = ['JawsM01', 'JawsM06', 'JawsM12', 'ChRM23']
    options['NEW_DATA'] = 0

    pc_list = []
    X_list = []
    y_list = []
    dfs = []
    for mouse in options['mice']:
        df_mouse = []
        options['mouse'] = mouse

        if mouse == 'all':
            options['mice'] = mice
            print(options['mice'])

        options = set_options(**options)
        days = options['days']
        print(days)

        if mouse in new_mice:
            options['NEW_DATA'] = 1
        else:
            options['NEW_DATA'] = 0

        X_, y_, pc_ = [], [], []

        for task in options['tasks']:
            options['task'] = task

            for day in days:
                options['day'] = day


                X_pca, y_pca, components, exp_var = get_classification(model, RETURN='pca', **options)
                options['reload'] = 0

                X_.append(X_pca)
                y_.append(y_pca)
                pc_.append(components)

                print(X_pca.shape, y_pca.shape, components.shape, exp_var.shape)
                df = pd.DataFrame(exp_var, columns=['explained_variance']).reset_index()
                df['day'] = day

                df_mouse.append(df)


        X_list.append(X_)
        pc_list.append(pc_)

        y_ = pd.concat(y_)
        y_['mouse'] = mouse
        y_list.append(y_)

        df_mouse = pd.concat(df_mouse)
        df_mouse['mouse'] = mouse
        dfs.append(df_mouse)

    return X_list, pd.concat(y_list), pc_list, pd.concat(dfs)
    #+end_src

#+RESULTS:

#+begin_src ipython
def save_overlaps(df, marg, dum, **options):
    if len(options['days'])>3:
        name = 'df_%s_%s_days' % (marg, dum)
    elif len(options['days'])==2:
        name = 'df_%s_%s_early_late' % (marg, dum)
    else:
        name = 'df_%s_%s' % (marg, dum)

    if len(mice)==1:
        pkl_save(df, '%s' % name, path="/storage/leon/dual_task/data/%s/overlaps" % options['mouse'])
    elif len(mice)==2:
        pkl_save(df, '%s' % name, path="/storage/leon/dual_task/data/mice/overlaps_ACC")
    else:
        pkl_save(df, '%s' % name, path="/storage/leon/dual_task/data/mice/overlaps")
#+end_src

#+RESULTS:

** run

#+begin_src ipython
import sys
sys.path.insert(0, '/home/leon/Dclassify')
from src.classificationCV import ClassificationCV
#+end_src

#+RESULTS:

#+begin_src ipython
options['n_jobs'] = 64
options['verbose'] = 1
net = None
params = {}
model = ClassificationCV(net, params, **options)
print(model.pipe)
#+end_src

#+RESULTS:
: PCA pca 5
: PCA 5
: Pipeline(steps=[('pca', PCA(n_components=5))])

#+begin_src ipython
options['epochs'] = ['TASK']
X_pca, y_pca, w_pca, df = decode_axis(model, **options)
 #+end_src

#+RESULTS:


#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=2, figsize=(2*width, height), sharey=1)

sns.lineplot(data=df[(df.day=='first')], x='index', y='explained_variance', hue='mouse', legend=None, alpha=0.2, ax=ax[0])
sns.lineplot(data=df[(df.day=='first')], x='index', y='explained_variance', color='k', ax=ax[0])

sns.lineplot(data=df[(df.day=='last')], x='index', y='explained_variance', hue='mouse', legend=None, alpha=0.2, ax=ax[1])
sns.lineplot(data=df[(df.day=='last')], x='index', y='explained_variance', color='k', ax=ax[1])

for k in range(2):
    ax[k].set_xlabel('PC #')
    ax[k].set_ylabel('Explained Variance')
    ax[k].set_xticks(np.arange(0, options['n_comp']), np.arange(1, options['n_comp']+1))

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_16.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

* Plots
** Data

#+begin_src ipython
n_comp = 3
learning = ['Naive', 'Expert']

X_mouse, y_mouse, pc_mouse = [], [], []

for i_day in range(len(options['days'])):

    X_, y_, pc_ = [], [], []
    for i_mouse in range(len(options['mice'])):


        if len(options['days']) == 2:
            y = y_pca[y_pca.mouse==options['mice'][i_mouse]]
            y = y[y.learning==learning[i_day]]
        else:
            y = y_pca[y_pca.mouse==options['mice'][i_mouse]]
            y = y[y.day==(i_day+1)]

        X = -np.array(X_pca[i_mouse][i_day][:]).swapaxes(1, -1)
        pcs = -np.array(w_pca[i_mouse][i_day] ).swapaxes(1, -1) * 100

        X_.append(X)
        y_.append(y)
        pc_.append(pcs)

        print(options['mice'][i_mouse], 'day', options['days'][i_day], 'X', X.shape, 'y', y.shape, 'pcs', pcs.shape)

    X_mouse.append(X_)
    y_mouse.append(y_)
    pc_mouse.append(pc_)
#+end_src

#+RESULTS:
#+begin_example
JawsM01 day first X (96, 5, 84) y (96, 18) pcs (5, 184)
JawsM06 day first X (96, 5, 84) y (96, 18) pcs (5, 201)
JawsM12 day first X (96, 5, 84) y (96, 18) pcs (5, 423)
JawsM15 day first X (96, 5, 84) y (96, 18) pcs (5, 693)
JawsM18 day first X (96, 5, 84) y (96, 18) pcs (5, 444)
ChRM04 day first X (96, 5, 84) y (96, 18) pcs (5, 668)
ChRM23 day first X (96, 5, 84) y (96, 18) pcs (5, 232)
JawsM01 day last X (32, 5, 84) y (32, 18) pcs (5, 184)
JawsM06 day last X (96, 5, 84) y (96, 18) pcs (5, 201)
JawsM12 day last X (64, 5, 84) y (64, 18) pcs (5, 423)
JawsM15 day last X (96, 5, 84) y (96, 18) pcs (5, 693)
JawsM18 day last X (96, 5, 84) y (96, 18) pcs (5, 444)
ChRM04 day last X (96, 5, 84) y (96, 18) pcs (5, 668)
ChRM23 day last X (64, 5, 84) y (64, 18) pcs (5, 232)
#+end_example

** Single mouse

#+begin_src ipython
i_mouse = 1
i_day = 1
z_lim = 10

X = X_mouse[i_day][i_mouse]
y = y_mouse[i_day][i_mouse]
pcs = pc_mouse[i_day][i_mouse]

print(options['mice'][i_mouse], 'day', options['days'][i_day], 'X', X.shape, 'y', y.shape, 'pcs', pcs.shape)
#+end_src

#+RESULTS:
: JawsM18 day last X (96, 5, 84) y (96, 18) pcs (5, 444)

*** Trajectories

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(4):
    mask = (y.odor_pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_20.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['A', 'B']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.sample_odor==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_21.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['unpair', 'pair']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_22.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['nolick', 'lick']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.choice==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_23.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

task = 'DualGo'
pair = ['AC', 'AD', 'BD', 'BC']

for i in range(4):
    mask = (y.odor_pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k])
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_24.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

task = 'DualNoGo'
for i in range(4):
    mask = (y.odor_pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k])
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_25.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = (X[(y.odor_pair==i) & (y.tasks==task)].mean(0))[:, :66]

    # X_avg = X[(y.odor_pair==i) & (y.tasks==task)]
    # idx = np.random.randint(X_avg.shape[0])
    # X_avg = X_avg[idx, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_26.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

*** Embeddings

#+begin_src ipython
import cmocean
cmap=cmocean.cm.phase

theta = np.arctan2(pcs[2], pcs[0]) * 180 / np.pi
idx = np.argsort(theta)

theta_norm = (theta+ 360) % (360)

counts, bins, patches = plt.hist(theta_norm, bins='auto', range=(0, 360), density=1)

bin_centers = 0.5*(bins[:-1] + bins[1:])
colors = [cmap(center/(360)) for center in bin_centers]

for patch, color in zip(patches, colors):
    patch.set_facecolor(color)

plt.xlabel('Neuron Loc (°)')
plt.ylabel('Density')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_28.png]]


#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, gaussian_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

size = 0.05

for k in range(n_comp):
    sc = ax[k].scatter(theta[idx], pcs[k][idx], alpha=0.5, c=theta_norm[idx], cmap=cmap)
    ax[k].plot(theta[idx], gaussian_filter1d(pcs[k][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
    ax[k].axhline(0, ls='--', color='k')
    ax[k].set_ylabel('Weights PC %d' % (k+1))
    ax[k].set_xlabel('Neuron Loc (°)')
    ax[k].set_ylim([-z_lim, z_lim])

ax[1].set_ylim([-z_lim/2, z_lim/2])
plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_29.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, uniform_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width))

ax[0].scatter(pcs[0][idx], pcs[1][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[0].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')

ax[0].set_xlabel('PC 1')
ax[0].set_ylabel('PC 2')

ax[1].scatter(pcs[0][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[1].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[1].set_xlabel('PC 1')
ax[1].set_ylabel('PC 3')

sc = ax[2].scatter(pcs[1][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[2].plot(gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[2].set_xlabel('PC 2')
ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].set_xlim(-z_lim, z_lim)
    ax[k].set_ylim(-z_lim, z_lim)

plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_30.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'),
           rasterized=1, color='k')


sc = ax.scatter(pcs[0][idx],
                pcs[1][idx],
                pcs[2][idx],
                c=theta_norm[idx], cmap=cmap,
                rasterized=1, alpha=0.5)

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim/10, z_lim/10])
ax.set_zlim([-z_lim, z_lim])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_31.png]]



#+RESULTS:

* All mice

#+begin_src ipython
import sys
sys.path.insert(0, '/home/leon/Dclassify')
from src.classificationCV import ClassificationCV
#+end_src

#+RESULTS:

#+begin_src ipython
options['n_jobs'] = 64
options['verbose'] = 1
net = None
params = {}
model = ClassificationCV(net, params, **options)
print(model.pipe)
#+end_src

#+RESULTS:
: PCA pca 5
: PCA 5
: Pipeline(steps=[('pca', PCA(n_components=5))])

#+begin_src ipython
from src.common.get_data import get_X_y_days, get_X_y_S1_S2, get_X_y_mice
from scipy.signal import detrend

options['trials']='correct'
options['reload'] = 0
options['laser'] = -1

options['days'] = ['first', 'last']
options['day'] = 'last'

options['task'] = 'DPA'

options['mice'] = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23']

X_mouse = []
for mouse in options['mice']:

    options['mouse'] = mouse
    X_days, y_days = get_X_y_days(**options)
    y_days = y_days.reset_index()

    print('X_days', X_days.shape, 'y_days', y_days.shape)
    y_days['idx'] = y_days['index'].copy()

    X, y = get_X_y_S1_S2(X_days, y_days, **options)
    y_labels = y.copy()

    X_avg = []
    for i in range(4):
        idx = (y_labels.odor_pair==i) # & (~y_labels.response.str.contains("incorrect"))

        if idx.mean()>0:
            X_avg.append(np.mean(X[idx], 0))

    X_avg = np.array(X_avg)
    X_mean = np.mean(X, 0)[np.newaxis]
    X_avg -= X_mean

    X_mouse.append(X_avg)
    print(X_avg.shape)
#+end_src

#+RESULTS:
#+begin_example
Loading files from /storage/leon/dual_task/data/JawsM01
X_days (768, 184, 84) y_days (768, 14)
DATA: FEATURES sample TASK DPA TRIALS correct DAYS last LASER -1
last [4] [1. 0.]
(4, 184, 84)
Loading files from /storage/leon/dual_task/data/JawsM06
X_days (1152, 201, 84) y_days (1152, 14)
DATA: FEATURES sample TASK DPA TRIALS correct DAYS last LASER -1
last [4 5 6] [1. 0.]
(4, 201, 84)
Loading files from /storage/leon/dual_task/data/JawsM12
X_days (960, 423, 84) y_days (960, 14)
DATA: FEATURES sample TASK DPA TRIALS correct DAYS last LASER -1
last [4 5] [1. 0.]
(4, 423, 84)
Loading files from /storage/leon/dual_task/data/JawsM15
X_days (1152, 693, 84) y_days (1152, 15)
DATA: FEATURES sample TASK DPA TRIALS correct DAYS last LASER -1
last [4. 5. 6.] [1. 0.]
(4, 693, 84)
Loading files from /storage/leon/dual_task/data/JawsM18
X_days (1152, 444, 84) y_days (1152, 15)
DATA: FEATURES sample TASK DPA TRIALS correct DAYS last LASER -1
last [4. 5. 6.] [1. 0.]
(4, 444, 84)
Loading files from /storage/leon/dual_task/data/ChRM04
X_days (1152, 668, 84) y_days (1152, 15)
DATA: FEATURES sample TASK DPA TRIALS correct DAYS last LASER -1
last [4. 5. 6.] [1. 0.]
(4, 668, 84)
Loading files from /storage/leon/dual_task/data/ChRM23
X_days (960, 232, 84) y_days (960, 14)
DATA: FEATURES sample TASK DPA TRIALS correct DAYS last LASER -1
last [4 5] [1. 0.]
(4, 232, 84)
#+end_example

#+begin_src ipython
X_mouse = np.hstack(X_mouse)
print(X_mouse.shape)
#+end_src

#+RESULTS:
: (4, 2845, 84)

#+begin_src ipython
options['epochs'] = ['POST_GNG']
X_flat = X_mouse[..., options['bins_' + options['epochs'][0]]].transpose(0, 2, 1).reshape(-1, X_mouse.shape[1])
model.fit_pca(X_flat)

X_flat = X_mouse.transpose(0, 2, 1).reshape(-1, X_mouse.shape[1])
X_pca = -model.transform_pca(X_flat).reshape(X_mouse.shape[0], X_mouse.shape[-1], -1)
print(X_pca.shape)
#+end_src

#+RESULTS:
: (4, 84, 5)

#+begin_src ipython
plt.plot(model.explained_variance_)
plt.xlabel('PC #')
plt.ylabel('Explained Variance')
plt.xticks(np.arange(0, options['n_comp']), np.arange(1, options['n_comp']+1))

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_37.png]]

** Trajectories

#+begin_src ipython
n_comp= 3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(4):
    X_avg = X_pca[i].T          # Subselect rows

    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_38.png]]

#+begin_src ipython
n_comp= 3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['A', 'B']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

X_sample = [(X_pca[0].T + X_pca[1].T)/2 , (X_pca[2].T + X_pca[3].T)/2]

for i in [0, 1]:
    X_avg = X_sample[i]

    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_39.png]]

#+begin_src ipython
n_comp= 3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['pair', 'unpair']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

X_pair = [(X_pca[0].T + X_pca[2].T)/2 , (X_pca[1].T + X_pca[3].T)/2]

for i in [0, 1]:
    X_avg = X_pair[i]

    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_40.png]]

#+begin_src ipython
n_comp= 3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['C', 'D']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

X_test = [(X_pca[0].T + X_pca[3].T)/2 , (X_pca[1].T + X_pca[2].T)/2]

for i in range(2):
    X_avg = X_test[i]

    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_41.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = X_pca[i].T[:, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_42.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Embeddings

#+begin_src ipython
z_lim = 5
pcs = model.components_ * 100
print(pcs.shape)
#+end_src

#+RESULTS:
: (5, 2845)

#+begin_src ipython
import cmocean
cmap=cmocean.cm.phase

theta = np.arctan2(pcs[0], pcs[1]) * 180 / np.pi
idx = np.argsort(theta)

theta_norm = (theta+ 360) % (360)

counts, bins, patches = plt.hist(theta_norm, bins='auto', range=(0, 360), density=1)

bin_centers = 0.5*(bins[:-1] + bins[1:])
colors = [cmap(center/(360)) for center in bin_centers]

for patch, color in zip(patches, colors):
    patch.set_facecolor(color)

plt.xlabel('Neuron Loc (°)')
plt.ylabel('Density')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_45.png]]


#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, gaussian_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

size = 0.1

for k in range(n_comp):
    sc = ax[k].scatter(theta[idx], pcs[k][idx], alpha=0.5, c=theta_norm[idx], cmap=cmap)
    ax[k].plot(theta[idx], gaussian_filter1d(pcs[k][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
    ax[k].axhline(0, ls='--', color='k')
    ax[k].set_ylabel('Weights PC %d' % (k+1))
    ax[k].set_xlabel('Neuron Loc (°)')
    ax[k].set_ylim([-z_lim, z_lim])

ax[-1].set_ylim([-z_lim/10, z_lim/10])
plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_46.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, uniform_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width))

ax[0].scatter(pcs[0][idx], pcs[1][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[0].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')

ax[0].set_xlabel('PC 1')
ax[0].set_ylabel('PC 2')

ax[1].scatter(pcs[0][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[1].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[1].set_xlabel('PC 1')
ax[1].set_ylabel('PC 3')

sc = ax[2].scatter(pcs[1][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[2].plot(gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[2].set_xlabel('PC 2')
ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].set_xlim(-z_lim, z_lim)
    ax[k].set_ylim(-z_lim, z_lim)

plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_47.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'),
           rasterized=1, color='k')


sc = ax.scatter(pcs[0][idx],
                pcs[1][idx],
                pcs[2][idx],
                c=theta_norm[idx], cmap=cmap,
                rasterized=1, alpha=0.5)

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim, z_lim])
ax.set_zlim([-z_lim/10, z_lim/10])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_48.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

* adeaf

#+begin_src ipython
from src.common.get_data import get_X_y_days, get_X_y_S1_S2, get_X_y_mice

options['reload'] = 0
options['epochs'] = ['all']
options['days'] = 'all'

X_mouse = []
X_all = []
y_all = []

options['mice'] = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23', 'ACCM03', 'ACCM04']

for mouse in options['mice']:
    options['mouse'] = mouse
    options = set_options(**options)

    X_day = []
    for day in options['days'][3:]:

        options['day'] = day

        X_days, y_days = get_X_y_days(**options)
        y_days = y_days.reset_index()
        y_days['idx'] = y_days['index'].copy()

        X, y = get_X_y_S1_S2(X_days, y_days, **options)
        y_labels = y.copy()

        if options['epochs'][0] == 'all':
            X_task = X.copy()
        else:
            X_task = X[..., options['bins_' + options['epochs'][0]]]

        X_avg = []
        for i in range(4):
            if options['task']!='all':
                idx = (y_labels.odor_pair==i)

                if idx.mean()>0:
                    X_avg.append(np.mean(X_task[idx], 0))
                else:
                    for k in range(len(y_labels.tasks.unique())):
                        task = y_labels.tasks.unique()[k]
                        idx = (y_labels.odor_pair==i) & (y_labels.tasks==task)

                        if 'Dual' in y_labels.tasks.unique()[k]:
                            idx = (y_labels.odor_pair==i) & (y_labels.tasks==task)

                        if idx.mean()>0:
                            X_avg.append(np.mean(X_task[idx], 0))

        X_avg = np.array(X_avg)
        X_mean = np.mean(X_task, 0)[np.newaxis]
        X_avg -= X_mean

        X_day.append(X_avg)

    X_mouse.append(np.nanmean(X_day, 0))
#+end_src
* CCA

#+begin_src ipython
from mvlearn.embed import MCCA
mcca = MCCA(n_components=3, regs='oas')

X= np.array(X_mouse[0])

X_reshaped = np.transpose(X, (0,1,3,2))
X_reshaped = X_reshaped.reshape(X.shape[0], X.shape[1]*X.shape[3], X.shape[2])

X_cca = mcca.fit_transform(X_reshaped)
X_reshaped = X_cca.reshape(X.shape[0], X.shape[1], X.shape[3], 3)
X_reshaped = np.transpose(X_reshaped, (0, 1, 3, 2))

pcs = np.array(mcca.loadings_)
#+end_src

#+RESULTS:
: (7, 5, 3)

#+begin_src ipython
i_mouse = 3
z_lim = 10

X = X_reshaped[i_mouse]
y = y_mouse[0][i_mouse]

print(options['mice'][i_mouse], 'day', options['days'][i_day], 'X', X.shape, 'y', y.shape, 'pcs', pcs.shape)
#+end_src

#+RESULTS:
: JawsM15 day last X (96, 3, 84) y (96, 18) pcs (7, 5, 3)

*** Trajectories

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(4):
    mask = (y.odor_pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_34.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['A', 'B']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.sample_odor==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_35.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['unpair', 'pair']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_36.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['nolick', 'lick']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.choice==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_37.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = (X[(y.odor_pair==i) & (y.tasks==task)].mean(0))[:, :66]

    # X_avg = X[(y.odor_pair==i) & (y.tasks==task)]
    # idx = np.random.randint(X_avg.shape[0])
    # X_avg = X_avg[idx, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_38.png]]

#+begin_src ipython

#+end_src

#+RESULTS:
