#+STARTUP: fold
#+PROPERTY: header-args:ipython :results both :exports both :async yes :session pca :kernel torch :output-dir ./figures/overlaps :file (lc/org-babel-tangle-figure-filename)

* Notebook Settings

#+begin_src ipython
import matplotlib.pyplot
#+end_src

#+RESULTS:


#+begin_src ipython
%load_ext autoreload
%autoreload 2
%reload_ext autoreload

%run /home/leon/dual_task/dual_data/notebooks/setup.py
# %config InlineBackend.figure_format = 'png'
#+end_src

#+RESULTS:
: The autoreload extension is already loaded. To reload it, use:
:   %reload_ext autoreload
: Python exe
: /home/leon/mambaforge/envs/torch/bin/python

* Imports

#+begin_src ipython
  from sklearn.exceptions import ConvergenceWarning
  warnings.filterwarnings("ignore")
  import traceback

  import sys
  sys.path.insert(0, '/home/leon/dual_task/dual_data/')

  import os
  if not sys.warnoptions:
    warnings.simplefilter("ignore")
    os.environ["PYTHONWARNINGS"] = "ignore"

  import pickle as pkl
  import numpy as np
  import matplotlib.pyplot as plt
  import pandas as pd
  import seaborn as sns

  from time import perf_counter

  from sklearn.base import clone
  from sklearn.metrics import make_scorer, roc_auc_score
  from sklearn.preprocessing import StandardScaler, RobustScaler
  from sklearn.model_selection import RepeatedStratifiedKFold, LeaveOneOut, StratifiedKFold

  from src.common.plot_utils import add_vlines, add_vdashed
  from src.common.options import set_options
  from src.stats.bootstrap import my_boots_ci
  from src.common.get_data import get_X_y_days, get_X_y_S1_S2
  from src.preprocess.helpers import avg_epochs
  from src.decode.bump import circcvl
  from src.torch.classificationCV import ClassificationCV
  from src.torch.classify import get_classification
#+end_src

#+RESULTS:

* Helpers

#+begin_src ipython
import numpy as np

class StandardScaler:
    def __init__(self, axis=0, if_scale=1):
        self.axis = axis
        self.center_ = None
        self.scale_ = None
        self.if_scale_ = if_scale

    def fit(self, X):
        self.center_ = np.nanmean(X, axis=self.axis, keepdims=True)
        self.scale_ = np.nanstd(X, axis=self.axis, keepdims=True)
        # Prevent division by zero
        self.scale_ = np.where(self.scale_ == 0, 1, self.scale_)
        return self

    def transform(self, X):
        if self.if_scale_:
            return (X - self.center_) / self.scale_
        return (X - self.center_)

    def fit_transform(self, X):
        self.fit(X)
        return self.transform(X)
#+end_src

#+RESULTS:

#+begin_src ipython
import numpy as np

class RobustScaler:
    def __init__(self, axis=0):
        self.axis = axis
        self.center_ = None
        self.scale_ = None

    def fit(self, X):
        self.center_ = np.nanmedian(X, axis=self.axis, keepdims=True)
        q75 = np.nanpercentile(X, 75, axis=self.axis, keepdims=True)
        q25 = np.nanpercentile(X, 25, axis=self.axis, keepdims=True)
        self.scale_ = q75 - q25
        # Prevent division by zero
        self.scale_ = np.where(self.scale_ == 0, 1, self.scale_)
        return self

    def transform(self, X):
        return (X - self.center_) / self.scale_

    def fit_transform(self, X):
        self.fit(X)
        return self.transform(X)
#+end_src

#+RESULTS:

#+begin_src ipython
def pad_list(arrays, axis=0, max_len=None):
    """
    Pads a list of arrays along the specified axis with NaNs so all have the same size along that axis.
    Returns a list of padded arrays.
    """
    # Find maximum size along specified axis
    if max_len is None:
        max_len = max(arr.shape[axis] for arr in arrays)

    padded = []
    for arr in arrays:
        pad_width = [(0, 0)] * arr.ndim


        n_pad = max_len - arr.shape[axis]

        if n_pad > 0:
            pad_width[axis] = (0, n_pad)
            arr_padded = np.pad(arr, pad_width, mode='constant', constant_values=np.nan)
        else:
            arr_padded = arr
        padded.append(arr_padded)

    return padded
#+end_src

#+RESULTS:

#+begin_src ipython
def avg_cond(X, y, **options):

    X_avg = []
    for i in range(4):
        idx = (y.odor_pair==i)

        if options['trials'] == 'correct':
            correct = ~y.response.str.contains("incorrect")
            idx  = (y.odor_pair==i) & correct

        if idx.mean()>0:
            X_avg.append(np.mean(X[idx], 0))

        # for j in range(2):
        #     idx = (y.sample_odor==i) & (y.choice==j)

        #     if idx.mean()>0:
        #         X_avg.append(np.mean(X[idx], 0))

        # X_avg.append(scaler.fit_transform(X[idx]))

        # for _, task in enumerate(options['tasks']):
        #     idx_task = idx & (y.tasks==task)

        #     if 'Dual' in task:
        #         if options['trials'] == 'correct':
        #             idx_task = idx & (y.tasks==task) & (y.odr_perf==1)

        #     if idx_task.mean()>0:
        #         # X_mean = np.mean(X[(y.tasks==task)], 0)
        #         # X_std = np.std(X[(y.tasks==task)], 0)
        #         # X_avg.append((np.mean(X[idx_task], 0) - X_mean) / X_std)

        #         X_avg.append(np.mean(X[idx_task], 0))

    return np.array(X_avg)
#+end_src

#+RESULTS:

#+RESULTS:

#+begin_src ipython
def pad_with_nans(array, target_shape):
    result = np.full(target_shape, np.nan)  # Create an array filled with NaNs
    print(result.shape)
    slices = tuple(slice(0, min(dim, target)) for dim, target in zip(array.shape, target_shape))
    result[slices] = array[slices]
    return result
#+end_src

#+RESULTS:

#+begin_src ipython :tangle ../src/torch/utils.py
  def convert_seconds(seconds):
      h = seconds // 3600
      m = (seconds % 3600) // 60
      s = seconds % 60
      return h, m, s
#+end_src

#+RESULTS:

#+begin_src ipython :tangle ../src/torch/utils.py
  import pickle as pkl

  def pkl_save(obj, name, path="."):
      os.makedirs(path, exist_ok=True)
      destination = path + "/" + name + ".pkl"
      print("saving to", destination)
      pkl.dump(obj, open(destination, "wb"))


  def pkl_load(name, path="."):
      source = path + "/" + name + '.pkl'
      print('loading from', source)
      return pkl.load(open( source, "rb"))

#+end_src

#+RESULTS:

* Parameters

#+begin_src ipython
old_mice = ['ChRM04','JawsM15', 'JawsM18', 'ACCM03', 'ACCM04']
Jaws_mice = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18']

mice = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23', 'ACCM03', 'ACCM04']
# mice = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23']
# mice = ['JawsM15', 'JawsM18', 'ChRM04']

tasks = ['Dual'] # all

kwargs = {
   'mice': mice,
   'tasks': tasks,
   'mouse': mice[0], 'laser': 0,
   'trials': '', 'reload': 0, 'data_type': 'dF',
   'prescreen': None, 'pval': 0.05,
   'preprocess': False, 'scaler_BL': 'standard',
   'avg_noise':False, 'unit_var_BL': False,
   'random_state': None, 'T_WINDOW': 0.0,
   'l1_ratio': 0.95,
   'n_comp': 3, 'pca': 'pca',
   'scaler': None,
   'bootstrap': 1, 'n_boots': 128,
   'n_splits': 5, 'n_repeats': 10,
   'class_weight': 0,
   'multilabel': 0,
   'mne_estimator':'generalizing', # sliding or generalizing
   'n_jobs': 64,
}

# kwargs['days'] = ['first', 'middle', 'last']
kwargs['days'] = ['first', 'last']
# kwargs['days'] = 'all'
options = set_options(**kwargs)
options['cv_B'] = False
#+end_src

#+RESULTS:

* Single Model
** Decoding vs days
*** utils

#+begin_src ipython
def decode_axis(model, **options):
    new_mice = ['JawsM01', 'JawsM06', 'JawsM12', 'ChRM23']
    options['NEW_DATA'] = 0

    pc_list = []
    X_list = []
    y_list = []
    dfs = []
    for mouse in options['mice']:
        df_mouse = []
        options['mouse'] = mouse

        if mouse == 'all':
            options['mice'] = mice
            print(options['mice'])

        options = set_options(**options)
        days = options['days']
        print(days)

        if mouse in new_mice:
            options['NEW_DATA'] = 1
        else:
            options['NEW_DATA'] = 0

        X_, y_, pc_ = [], [], []

        for task in options['tasks']:
            options['task'] = task

            for day in days:
                options['day'] = day


                X_pca, y_pca, components, exp_var = get_classification(model, RETURN='pca', **options)
                options['reload'] = 0

                X_.append(X_pca)
                y_.append(y_pca)
                pc_.append(components)

                print(X_pca.shape, y_pca.shape, components.shape, exp_var.shape)
                df = pd.DataFrame(exp_var, columns=['explained_variance']).reset_index()
                df['day'] = day

                df_mouse.append(df)


        X_list.append(X_)
        pc_list.append(pc_)

        y_ = pd.concat(y_)
        y_['mouse'] = mouse
        y_list.append(y_)

        df_mouse = pd.concat(df_mouse)
        df_mouse['mouse'] = mouse
        dfs.append(df_mouse)

    return X_list, pd.concat(y_list), pc_list, pd.concat(dfs)
    #+end_src

#+RESULTS:

#+begin_src ipython
def save_overlaps(df, marg, dum, **options):
    if len(options['days'])>3:
        name = 'df_%s_%s_days' % (marg, dum)
    elif len(options['days'])==2:
        name = 'df_%s_%s_early_late' % (marg, dum)
    else:
        name = 'df_%s_%s' % (marg, dum)

    if len(mice)==1:
        pkl_save(df, '%s' % name, path="/storage/leon/dual_task/data/%s/overlaps" % options['mouse'])
    elif len(mice)==2:
        pkl_save(df, '%s' % name, path="/storage/leon/dual_task/data/mice/overlaps_ACC")
    else:
        pkl_save(df, '%s' % name, path="/storage/leon/dual_task/data/mice/overlaps")
#+end_src

#+RESULTS:

*** run

#+begin_src ipython
import sys
sys.path.insert(0, '/home/leon/Dclassify')
from src.classificationCV import ClassificationCV
#+end_src

#+RESULTS:

#+begin_src ipython
options['n_jobs'] = 64
options['verbose'] = 1
net = None
params = {}
model = ClassificationCV(net, params, **options)
print(model.pipe)
#+end_src

#+RESULTS:
: PCA pca 5
: PCA 5
: Pipeline(steps=[('pca', PCA(n_components=5))])

#+begin_src ipython
options['epochs'] = ['POST_GNG']
X_pca, y_pca, w_pca, df = decode_axis(model, **options)
 #+end_src

#+RESULTS:
#+begin_example
['first', 'last']
Loading files from /storage/leon/dual_task/data/JawsM01
X_days (768, 184, 84) y_days (768, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1 2 3] [1. 0.]
Training set: X (192, 184, 84) y_labels (192, 16) ['DualNoGo' 'DualGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 16) (5, 184) (5,)
Loading files from /storage/leon/dual_task/data/JawsM01
X_days (768, 184, 84) y_days (768, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4] [1. 0.]
Training set: X (64, 184, 84) y_labels (64, 16) ['DualGo' 'DualNoGo'] (64,)
Elapsed (with compilation) = 0h 0m 0s
(64, 84, 5) (64, 16) (5, 184) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/JawsM06
X_days (1152, 201, 84) y_days (1152, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1 2 3] [1. 0.]
Training set: X (192, 201, 84) y_labels (192, 16) ['DualNoGo' 'DualGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 16) (5, 201) (5,)
Loading files from /storage/leon/dual_task/data/JawsM06
X_days (1152, 201, 84) y_days (1152, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4 5 6] [1. 0.]
Training set: X (192, 201, 84) y_labels (192, 16) ['DualGo' 'DualNoGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 16) (5, 201) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/JawsM12
X_days (960, 423, 84) y_days (960, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1 2 3] [1. 0.]
Training set: X (192, 423, 84) y_labels (192, 16) ['DualGo' 'DualNoGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 16) (5, 423) (5,)
Loading files from /storage/leon/dual_task/data/JawsM12
X_days (960, 423, 84) y_days (960, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4 5] [1. 0.]
Training set: X (128, 423, 84) y_labels (128, 16) ['DualGo' 'DualNoGo'] (128,)
Elapsed (with compilation) = 0h 0m 0s
(128, 84, 5) (128, 16) (5, 423) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/JawsM15
X_days (1152, 693, 84) y_days (1152, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1. 2. 3.] [1. 0.]
Training set: X (192, 693, 84) y_labels (192, 17) ['DualGo' 'DualNoGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 17) (5, 693) (5,)
Loading files from /storage/leon/dual_task/data/JawsM15
X_days (1152, 693, 84) y_days (1152, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4. 5. 6.] [1. 0.]
Training set: X (192, 693, 84) y_labels (192, 17) ['DualGo' 'DualNoGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 17) (5, 693) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/JawsM18
X_days (1152, 444, 84) y_days (1152, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1. 2. 3.] [1. 0.]
Training set: X (192, 444, 84) y_labels (192, 17) ['DualNoGo' 'DualGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 17) (5, 444) (5,)
Loading files from /storage/leon/dual_task/data/JawsM18
X_days (1152, 444, 84) y_days (1152, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4. 5. 6.] [1. 0.]
Training set: X (192, 444, 84) y_labels (192, 17) ['DualNoGo' 'DualGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 17) (5, 444) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/ChRM04
X_days (1152, 668, 84) y_days (1152, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1. 2. 3.] [1. 0.]
Training set: X (192, 668, 84) y_labels (192, 17) ['DualNoGo' 'DualGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 17) (5, 668) (5,)
Loading files from /storage/leon/dual_task/data/ChRM04
X_days (1152, 668, 84) y_days (1152, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4. 5. 6.] [1. 0.]
Training set: X (192, 668, 84) y_labels (192, 17) ['DualNoGo' 'DualGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 17) (5, 668) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/ChRM23
X_days (960, 232, 84) y_days (960, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1 2 3] [1. 0.]
Training set: X (192, 232, 84) y_labels (192, 16) ['DualGo' 'DualNoGo'] (192,)
Elapsed (with compilation) = 0h 0m 0s
(192, 84, 5) (192, 16) (5, 232) (5,)
Loading files from /storage/leon/dual_task/data/ChRM23
X_days (960, 232, 84) y_days (960, 14)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4 5] [1. 0.]
Training set: X (128, 232, 84) y_labels (128, 16) ['DualNoGo' 'DualGo'] (128,)
Elapsed (with compilation) = 0h 0m 0s
(128, 84, 5) (128, 16) (5, 232) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/ACCM03
X_days (960, 361, 84) y_days (960, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1. 2. 3.] [1. 0.]
Training set: X (384, 361, 84) y_labels (384, 17) ['DualGo' 'DualNoGo'] (384,)
Elapsed (with compilation) = 0h 0m 0s
(384, 84, 5) (384, 17) (5, 361) (5,)
Loading files from /storage/leon/dual_task/data/ACCM03
X_days (960, 361, 84) y_days (960, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4. 5.] [1. 0.]
Training set: X (256, 361, 84) y_labels (256, 17) ['DualGo' 'DualNoGo'] (256,)
Elapsed (with compilation) = 0h 0m 0s
(256, 84, 5) (256, 17) (5, 361) (5,)
['first', 'last']
Loading files from /storage/leon/dual_task/data/ACCM04
X_days (960, 113, 84) y_days (960, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS first LASER 0
first [1. 2. 3.] [1. 0.]
Training set: X (384, 113, 84) y_labels (384, 17) ['DualNoGo' 'DualGo'] (384,)
Elapsed (with compilation) = 0h 0m 0s
(384, 84, 5) (384, 17) (5, 113) (5,)
Loading files from /storage/leon/dual_task/data/ACCM04
X_days (960, 113, 84) y_days (960, 15)
DATA: FEATURES sample TASK Dual TRIALS  DAYS last LASER 0
last [4. 5.] [1. 0.]
Training set: X (256, 113, 84) y_labels (256, 17) ['DualGo' 'DualNoGo'] (256,)
Elapsed (with compilation) = 0h 0m 0s
(256, 84, 5) (256, 17) (5, 113) (5,)
#+end_example

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=2, figsize=(2*width, height), sharey=1)

sns.lineplot(data=df[(df.day=='first')], x='index', y='explained_variance', hue='mouse', legend=None, alpha=0.2, ax=ax[0])
sns.lineplot(data=df[(df.day=='first')], x='index', y='explained_variance', color='k', ax=ax[0])

sns.lineplot(data=df[(df.day=='last')], x='index', y='explained_variance', hue='mouse', legend=None, alpha=0.2, ax=ax[1])
sns.lineplot(data=df[(df.day=='last')], x='index', y='explained_variance', color='k', ax=ax[1])

for k in range(2):
    ax[k].set_xlabel('PC #')
    ax[k].set_ylabel('Explained Variance')
    ax[k].set_xticks(np.arange(0, options['n_comp']), np.arange(1, options['n_comp']+1))

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_16.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Plots
*** Data

#+begin_src ipython
n_comp = 5
learning = ['Naive', 'Expert']

X_mouse, y_mouse, pc_mouse = [], [], []

for i_day in range(len(options['days'])):

    X_, y_, pc_ = [], [], []
    for i_mouse in range(len(options['mice'])):


        if len(options['days']) == 2:
            y = y_pca[y_pca.mouse==options['mice'][i_mouse]]
            y = y[y.learning==learning[i_day]]
        else:
            y = y_pca[y_pca.mouse==options['mice'][i_mouse]]
            y = y[y.day==(i_day+1)]

        X = np.array(X_pca[i_mouse][i_day][:]).swapaxes(1, -1)
        pcs = np.array(w_pca[i_mouse][i_day] ).swapaxes(1, -1) * 100

        X_.append(X)
        y_.append(y)
        pc_.append(pcs)

        print(options['mice'][i_mouse], 'day', options['days'][i_day], 'X', X.shape, 'y', y.shape, 'pcs', pcs.shape)

    X_mouse.append(X_)
    y_mouse.append(y_)
    pc_mouse.append(pc_)
#+end_src

#+RESULTS:
#+begin_example
JawsM01 day first X (192, 5, 84) y (192, 18) pcs (5, 184)
JawsM06 day first X (192, 5, 84) y (192, 18) pcs (5, 201)
JawsM12 day first X (192, 5, 84) y (192, 18) pcs (5, 423)
JawsM15 day first X (192, 5, 84) y (192, 18) pcs (5, 693)
JawsM18 day first X (192, 5, 84) y (192, 18) pcs (5, 444)
ChRM04 day first X (192, 5, 84) y (192, 18) pcs (5, 668)
ChRM23 day first X (192, 5, 84) y (192, 18) pcs (5, 232)
ACCM03 day first X (384, 5, 84) y (384, 18) pcs (5, 361)
ACCM04 day first X (384, 5, 84) y (384, 18) pcs (5, 113)
JawsM01 day last X (64, 5, 84) y (64, 18) pcs (5, 184)
JawsM06 day last X (192, 5, 84) y (192, 18) pcs (5, 201)
JawsM12 day last X (128, 5, 84) y (128, 18) pcs (5, 423)
JawsM15 day last X (192, 5, 84) y (192, 18) pcs (5, 693)
JawsM18 day last X (192, 5, 84) y (192, 18) pcs (5, 444)
ChRM04 day last X (192, 5, 84) y (192, 18) pcs (5, 668)
ChRM23 day last X (128, 5, 84) y (128, 18) pcs (5, 232)
ACCM03 day last X (256, 5, 84) y (256, 18) pcs (5, 361)
ACCM04 day last X (256, 5, 84) y (256, 18) pcs (5, 113)
#+end_example

*** Single mouse

#+begin_src ipython
i_mouse = 3
i_day = 0
z_lim = 10

X = X_mouse[i_day][i_mouse]
y = y_mouse[i_day][i_mouse]
pcs = pc_mouse[i_day][i_mouse]

print(options['mice'][i_mouse], 'day', options['days'][i_day], 'X', X.shape, 'y', y.shape, 'pcs', pcs.shape)
#+end_src

#+RESULTS:
: JawsM15 day first X (192, 5, 84) y (192, 18) pcs (5, 693)

**** Trajectories

#+begin_src ipython
n_comp=3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 84)

for i in range(4):
    mask = (y.odor_pair==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_20.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['A', 'B']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.sample_odor==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_21.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['unpair', 'pair']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.pair==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_22.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['nolick', 'lick']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.choice==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_23.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['C', 'D']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.test_odor==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_24.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

task = 'DualGo'
pair = ['AC', 'AD', 'BD', 'BC']

for i in range(4):
    mask = (y.odor_pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k])
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_25.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

task = 'DualNoGo'
for i in range(4):
    mask = (y.odor_pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k])
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_26.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DualGo'
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = (X[(y.odor_pair==i) & (y.tasks==task)].mean(0))[:, :66]

    # X_avg = X[(y.odor_pair==i) & (y.tasks==task)]
    # idx = np.random.randint(X_avg.shape[0])
    # X_avg = X_avg[idx, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_27.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

**** Embeddings

#+begin_src ipython
import cmocean
cmap=cmocean.cm.phase

theta = np.arctan2(pcs[1], pcs[0]) * 180 / np.pi
idx = np.argsort(theta)

theta_norm = (theta+ 360) % (360)

counts, bins, patches = plt.hist(theta_norm, bins='auto', range=(0, 360), density=1)

bin_centers = 0.5*(bins[:-1] + bins[1:])
colors = [cmap(center/(360)) for center in bin_centers]

for patch, color in zip(patches, colors):
    patch.set_facecolor(color)

plt.xlabel('Neuron Loc (°)')
plt.ylabel('Density')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_29.png]]


#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, gaussian_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

size = 0.05

for k in range(n_comp):
    sc = ax[k].scatter(theta[idx], pcs[k][idx], alpha=0.5, c=theta_norm[idx], cmap=cmap)
    ax[k].plot(theta[idx], gaussian_filter1d(pcs[k][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
    ax[k].axhline(0, ls='--', color='k')
    ax[k].set_ylabel('Weights PC %d' % (k+1))
    ax[k].set_xlabel('Neuron Loc (°)')
    ax[k].set_ylim([-z_lim, z_lim])

ax[-1].set_ylim([-z_lim/2, z_lim/2])
plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_30.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, uniform_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width))

ax[0].scatter(pcs[0][idx], pcs[1][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[0].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')

ax[0].set_xlabel('PC 1')
ax[0].set_ylabel('PC 2')

ax[1].scatter(pcs[0][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[1].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[1].set_xlabel('PC 1')
ax[1].set_ylabel('PC 3')

sc = ax[2].scatter(pcs[1][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[2].plot(gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[2].set_xlabel('PC 2')
ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].set_xlim(-z_lim, z_lim)
    ax[k].set_ylim(-z_lim, z_lim)

plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_31.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'),
           rasterized=1, color='k')


sc = ax.scatter(pcs[0][idx],
                pcs[1][idx],
                pcs[2][idx],
                c=theta_norm[idx], cmap=cmap,
                rasterized=1, alpha=0.5)

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim, z_lim])
ax.set_zlim([-z_lim/10, z_lim/10])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_32.png]]


#+begin_src ipython

#+end_src

#+RESULTS:

* Meta Model
** Model

#+begin_src ipython
import sys
sys.path.insert(0, '/home/leon/Dclassify')
from src.classificationCV import ClassificationCV
#+end_src

#+RESULTS:

#+begin_src ipython
options['n_jobs'] = 64
options['verbose'] = 0
net = None
params = {}
model = ClassificationCV(net, params, **options)
print(model.pipe)
#+end_src

#+RESULTS:
: PCA pca 3
: PCA 3
: Pipeline(steps=[('pca', PCA(n_components=3))])

#+RESULTS:

#+begin_src ipython
from src.common.get_data import get_X_y_days, get_X_y_S1_S2, get_X_y_mice
from scipy.signal import detrend

options['trials'] = ''
options['reload'] = 0
options['laser'] = 0

options['days'] = ['first', 'last']
# options['days'] = 'all'

options['tasks'] = ['DPA']
options['task'] = 'DPA'

options['mice'] = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23', 'ACCM03', 'ACCM04']
if options['laser']!=0:
    options['mice'] = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18']

options['mice'] = ['JawsM01', 'JawsM15']

scaler = StandardScaler(axis=0)

X_mouse = []
for mouse in options['mice']:
    options['mouse'] = mouse
    options = set_options(**options)

    X_day = []
    for day in options['days']:
        options['day'] = day

        X_days, y_days = get_X_y_days(**options)

        X, y = get_X_y_S1_S2(X_days, y_days, **options)
        print(y.tasks.unique())

        X = scaler.fit_transform(X)
        X_avg = avg_cond(X, y, **options)
        print(X_avg.shape)

        # scaler.fit(X)
        # X_avg = scaler.transform(X_avg)

        # X_mean = np.mean(X_avg, (0, -1), keepdims=1)
        # X_std = np.std(X_avg, (0, -1), keepdims=1)
        # X_avg = (X_avg - X_mean) # / X_std

        X_day.append(X_avg)

    # X_day = np.array(pad_list(X_day, 0, 8))
    X_day = np.array(X_day)

    print('X_day', X_day.shape)
    X_mouse.append(X_day)

X_mouse = pad_list(X_mouse)
#+end_src

#+RESULTS:
#+begin_example
first [1 2 3] [1. 0.]
['DPA']
(4, 184, 84)
last [4] [1. 0.]
['DPA']
(4, 184, 84)
X_day (2, 4, 184, 84)
first [1. 2. 3.] [0. 1.]
['DPA']
(4, 693, 84)
last [4. 5. 6.] [1. 0.]
['DPA']
(4, 693, 84)
X_day (2, 4, 693, 84)
#+end_example

#+begin_src ipython
X_mouse = np.concatenate(X_mouse, axis=2)
# X_mouse = np.hstack(X_mouse)
print(X_mouse.shape)
#+end_src

#+RESULTS:
: (2, 4, 877, 84)

** PCA

#+begin_src ipython
from sklearn.impute import SimpleImputer
# imputer = SimpleImputer(strategy='mean')

options['epochs'] = ['TASK']

traj_day, w_day, evr_day = [], [], []
for i_day, day in enumerate(options['days']):

    X_day = X_mouse[i_day]
    mask = ~np.all(np.isnan(X_day), axis=(0, 2))
    X_day = X_day[:, mask]

    # mask = ~np.all(np.isnan(X_day), axis=(0, 1))
    # X_day = X_day[..., mask]
    # print(mask.shape, np.isnan(X_day).sum())

    # X_flat = X_day[..., options['bins_' + options['epochs'][0]]].transpose(0, 2, 1).reshape(-1, X_day.shape[1])
    # X_flat = imputer.fit_transform(X_flat)

    X_flat = X_day.transpose(0, 2, 1).reshape(-1, X_day.shape[1])
    print(X_flat.shape)

    X_pca = cross_val_pca(X_flat, 336, 5)
    print(X_pca.shape)

    traj_day.append(X_pca.reshape(X_day.shape[0], X_day.shape[-1], -1))

    # X_mean = np.nanmean(X_flat, 0, keepdims=1)
    # X_std = np.nanstd(X_flat, 0, keepdims=1)
    # X_flat = (X_flat - X_mean) # / X_std

    # model.fit_pca(X_flat)

    # w_day.append(model.components_)
    # evr_day.append(model.explained_variance_)

    # X_flat = X_day.transpose(0, 2, 1).reshape(-1, X_day.shape[1])
    # X_flat = (X_flat - X_mean)  # / X_std

    # X_pca = model.transform_pca(X_flat).reshape(X_day.shape[0], X_day.shape[-1], -1)
    # print(X_pca.shape)

    # traj_day.append(X_pca)
#+end_src

#+RESULTS:
: (336, 3319)

#+begin_src ipython
print(np.array(traj_day).shape)
#+end_src

#+RESULTS:
: d334b32a-d3a6-4b29-8db0-907461ff57d0

#+begin_src ipython
from sklearn.model_selection import KFold
from sklearn.decomposition import PCA

def cross_val_pca(X, n_splits, n_comp):
    kf = KFold(n_splits, shuffle=True)
    pca = PCA(n_components=n_comp)

    X_folds = []
    for train_idx, test_idx in kf.split(X):
        X_train, X_test = X[train_idx], X[test_idx]

        X_mean = np.nanmean(X_train, 0, keepdims=1)
        X_cent = (X_train - X_mean)

        pca.fit(X_cent)

        X_pca = pca.transform(X_test - X_mean)
        X_folds.append(X_pca)

    return np.nanmean(X_folds, 0)
#+end_src

#+RESULTS:

#+begin_src ipython
for i_day, day in enumerate(options['days']):
    plt.plot(evr_day[i_day], '-o', label=day)

plt.xlabel('PC #')
plt.ylabel('Explained Variance')
plt.legend(fontsize=18, frameon=0)
plt.xticks(np.arange(0, options['n_comp']), np.arange(1, options['n_comp']+1))

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_43.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Trajectories

#+begin_src ipython
print(X_pca.shape)
#+end_src

#+RESULTS:
: (4, 84, 5)

#+begin_src ipython
n_comp= 3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']

xtime = np.linspace(0, 14, 84)

for i in range(X_pca.shape[0]):
    X_avg = X_pca[i].T

    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_52.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['A', 'B']
xtime = np.linspace(0, 14, 84)

X_sample = [(X_pca[0].T + X_pca[1].T)/2 , (X_pca[2].T + X_pca[3].T)/2]

for i in [0, 1]:
    X_avg = X_sample[i] # - shuff[i]


    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_53.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['pair', 'unpair']
xtime = np.linspace(0, 14, 84)

X_pair = [(X_pca[0].T + X_pca[2].T)/2 , (X_pca[1].T + X_pca[3].T)/2]

# if options['n_shuff']>0:
#     shuff = [(mean_shuff[0].T + mean_shuff[2].T)/2 , (mean_shuff[1].T + mean_shuff[3].T)/2]

for i in [0, 1]:
    X_avg = X_pair[i] # - shuff[i]

    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_54.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['C', 'D']

xtime = np.linspace(0, 14, 84)

X_test = [(X_pca[0].T + X_pca[3].T)/2 , (X_pca[1].T + X_pca[2].T)/2]

# if options['n_shuff']>0:
#     shuff = [(mean_shuff[0].T + mean_shuff[3].T)/2 , (mean_shuff[1].T + mean_shuff[2].T)/2]

for i in range(2):
    X_avg = X_test[i] # - shuff[i]

    for k in range(n_comp):
        y_avg = X_avg[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_55.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = X_pca[i].T[:, :66] # - mean_shuff[i].T[:, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_56.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Embeddings

#+begin_src ipython
z_lim = 5
pcs = model.components_ * 100
print(pcs.shape)
#+end_src

#+RESULTS:
: (3, 3319)

#+begin_src ipython
import numpy as np

# lower = np.percentile(w_shuff, 95, axis=0)   # [3, 3319]
# upper = np.percentile(w_shuff, 5, axis=0)  # [3, 3319]

# significant = (pcs < lower) | (pcs > upper)      # [3, 3319]
# pc_sig = pcs * significant

# for pc_idx in range(pcs.shape[0]):
#     sig_idx = np.where(significant[pc_idx, :])[0]
#     print(f"PC{pc_idx+1}: {len(sig_idx)} significant neurons")

pc_list = []
# for pc_idx in range(pcs.shape[0]):  # for each PC
#     sig_idx = np.where(significant[pc_idx, :])[0]
#     pc_list.append(pcs[pc_idx, sig_idx])

#     mask = significant[pc_idx, :]           # Boolean mask, True means significant
#     pcs[pc_idx, ~mask] = np.nan             # Set NON-significant entries to NaN

pc_list = np.array(pc_list, dtype=object)
print(pc_list.shape)
#+end_src

#+RESULTS:
: (0,)

#+begin_src ipython
import cmocean
cmap=cmocean.cm.phase

theta = np.arctan2(pcs[1], pcs[0]) * 180 / np.pi
idx = np.argsort(theta)

theta_norm = (theta+ 360) % (360)

counts, bins, patches = plt.hist(theta_norm, bins='auto', range=(0, 360), density=1)

bin_centers = 0.5*(bins[:-1] + bins[1:])
colors = [cmap(center/(360)) for center in bin_centers]

for patch, color in zip(patches, colors):
    patch.set_facecolor(color)

plt.xlabel('Neuron Loc (°)')
plt.ylabel('Density')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_54.png]]

#+begin_src ipython
import numpy as np
from scipy.ndimage import gaussian_filter1d

def nan_gaussian_filter1d(data, sigma, **kwargs):
    """Gaussian smoothing ignoring NaNs."""
    data = np.asarray(data)
    nan_mask = np.isnan(data)
    data_filled = data.copy()
    data_filled[nan_mask] = 0
    weights = (~nan_mask).astype(float)
    filtered = gaussian_filter1d(data_filled, sigma, **kwargs)
    weights_filtered = gaussian_filter1d(weights, sigma, **kwargs)
    with np.errstate(invalid='ignore', divide='ignore'):
        result = filtered / weights_filtered
    result[weights_filtered == 0] = np.nan
    return result
#+end_src

#+RESULTS:

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, gaussian_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

size = 0.1

for k in range(n_comp):
    sc = ax[k].scatter(theta[idx], pcs[k][idx], alpha=0.5, c=theta_norm[idx], cmap=cmap)
    ax[k].plot(theta[idx], nan_gaussian_filter1d(pcs[k][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
    ax[k].axhline(0, ls='--', color='k')
    ax[k].set_ylabel('Weights PC %d' % (k+1))
    ax[k].set_xlabel('Neuron Loc (°)')
    ax[k].set_ylim([-z_lim, z_lim])

ax[-1].set_ylim([-z_lim/10, z_lim/10])
plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_56.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, uniform_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width))

ax[0].scatter(pcs[0][idx], pcs[1][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[0].plot(nan_gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), nan_gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')

ax[0].set_xlabel('PC 1')
ax[0].set_ylabel('PC 2')

ax[1].scatter(pcs[0][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[1].plot(nan_gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), nan_gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[1].set_xlabel('PC 1')
ax[1].set_ylabel('PC 3')

sc = ax[2].scatter(pcs[1][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[2].plot(nan_gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), nan_gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[2].set_xlabel('PC 2')
ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].set_xlim(-z_lim, z_lim)
    ax[k].set_ylim(-z_lim, z_lim)

plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_57.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(nan_gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'),
        nan_gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'),
        nan_gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'),
           rasterized=1, color='k')


sc = ax.scatter(pcs[0][idx],
                pcs[1][idx],
                pcs[2][idx],
                c=theta_norm[idx], cmap=cmap,
                rasterized=1, alpha=0.5)

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim, z_lim])
ax.set_zlim([-z_lim/10, z_lim/10])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_58.png]]


#+begin_src ipython
nbins = 30
theta_bins = np.linspace(-180, 180, nbins+1)
theta_digitized = np.digitize(theta, theta_bins) - 1

pcs_binned = np.zeros((3, nbins))
for i in range(nbins):
    mask = theta_digitized == i
    for j in range(3):
        pcs_binned[j, i] = np.mean(pcs[j][mask]) if np.any(mask) else np.nan

pcs_smooth = gaussian_filter1d(pcs_binned, sigma=2, axis=1, mode='wrap')
#+end_src

#+RESULTS:

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

for i, ax in enumerate(axs):
    ax.plot(theta_plot * 180 / np.pi, pcs_smooth[i], lw=2)
    ax.axhline(0, ls='--', color='k')
    ax.set_ylabel('Weights PC %d' % (i+1))
    ax.set_xlabel('Neuron Loc (°)')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_60.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

# Compute bin centers in degrees and radians
bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)  # for polar plots

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width), sharey=1)

# PC1 vs PC2
axs[0].plot(pcs_smooth[0], pcs_smooth[1], 'k-')
axs[0].set_xlabel('PC 1')
axs[0].set_ylabel('PC 2')

# PC1 vs PC3
axs[1].plot(pcs_smooth[0], pcs_smooth[2], 'k-')
axs[1].set_xlabel('PC 1')
axs[1].set_ylabel('PC 3')

# PC2 vs PC3
axs[2].plot(pcs_smooth[1], pcs_smooth[2], 'k-')
axs[2].set_xlabel('PC 2')
axs[2].set_ylabel('PC 3')

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_61.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(1, 3, subplot_kw={'polar': True}, figsize=(n_comp*width, width))

for i, ax in enumerate(axs):
    ax.plot(theta_plot, pcs_smooth[i], lw=2)

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_62.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(pcs_smooth[0], pcs_smooth[1], pcs_smooth[2], rasterized=1, color='k')

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim, z_lim])
ax.set_zlim([-z_lim/10, z_lim/10])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_63.png]]


#+begin_src ipython

#+end_src

#+RESULTS:

* Single mouse
** Data

#+begin_src ipython
X_trials, y_trials = [], []
scaler = StandardScaler(axis=0)

counter = 0
for mouse in options['mice']:

    options['mouse'] = mouse
    X_days, y_days = get_X_y_days(**options)
    y_days = y_days.reset_index()

    print('X_days', X_days.shape, 'y_days', y_days.shape)
    y_days['idx'] = y_days['index'].copy()

    X, y = get_X_y_S1_S2(X_days, y_days, **options)

    X_scaled = scaler.fit_transform(X)

    # X_mean = np.mean(X, 0)[np.newaxis]
    # X_std = np.std(X, 0)[np.newaxis]
    # X_scaled = (X - X_mean) / X_std

    X_trial = np.zeros((X.shape[0], X_mouse.shape[2], X.shape[-1]))
    X_trial[:, counter:X.shape[1]+counter, :] = X_scaled

    counter += X.shape[1]

    X_trials.append(X_trial)
    y_trials.append(y)

X_trials = np.array(X_trials, dtype=object)
y_trials = np.array(y_trials, dtype=object)
#+end_src

#+RESULTS:
#+begin_example
X_days (768, 184, 84) y_days (768, 14)
last [4] [1. 0.]
X_days (1152, 201, 84) y_days (1152, 14)
last [4 5 6] [1. 0.]
X_days (960, 423, 84) y_days (960, 14)
last [4 5] [1. 0.]
X_days (1152, 693, 84) y_days (1152, 15)
last [4. 5. 6.] [1. 0.]
X_days (1152, 444, 84) y_days (1152, 15)
last [4. 5. 6.] [1. 0.]
X_days (1152, 668, 84) y_days (1152, 15)
last [4. 5. 6.] [1. 0.]
X_days (960, 232, 84) y_days (960, 14)
last [4 5] [1. 0.]
X_days (960, 361, 84) y_days (960, 15)
last [4. 5.] [1. 0.]
X_days (960, 113, 84) y_days (960, 15)
last [4. 5.] [1. 0.]
#+end_example


#+begin_src ipython
pca_list = []
for i, mouse in enumerate(options['mice']):

    X_i = X_trials[i] # single trials for given mouse
    X_flat = X_i.transpose(0, 2, 1).reshape(-1, X_i.shape[1])

    X_i_pca = model.transform_pca(X_flat-X_mean).reshape(X_i.shape[0], X_i.shape[-1], -1)

    print(mouse, X_i.shape, X_flat.shape, X_i_pca.shape)

    pca_list.append(X_i_pca)

pca_list = np.array(pca_list, dtype=object)
print('pca', pca_list.shape)
#+end_src

#+RESULTS:
#+begin_example
JawsM01 (32, 3319, 84) (2688, 3319) (32, 84, 3)
JawsM06 (96, 3319, 84) (8064, 3319) (96, 84, 3)
JawsM12 (64, 3319, 84) (5376, 3319) (64, 84, 3)
JawsM15 (96, 3319, 84) (8064, 3319) (96, 84, 3)
JawsM18 (96, 3319, 84) (8064, 3319) (96, 84, 3)
ChRM04 (96, 3319, 84) (8064, 3319) (96, 84, 3)
ChRM23 (64, 3319, 84) (5376, 3319) (64, 84, 3)
ACCM03 (128, 3319, 84) (10752, 3319) (128, 84, 3)
ACCM04 (128, 3319, 84) (10752, 3319) (128, 84, 3)
pca (9,)
#+end_example

** avg odor pair trajectory

#+begin_src ipython
traj_mouse = []
for i_mouse, mouse in enumerate(options['mice'][3:7]):
    X = np.swapaxes(pca_list[i_mouse], 1, 2)
    y = y_trials[i_mouse]

    traj_ = []
    for i in range(4):
        mask = (y.odor_pair==i) & ~y.response.str.contains("incorrect")
        traj_.append(X[mask].mean(0))
    traj_mouse.append(traj_)

traj_mouse = np.array(traj_mouse)
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (4, 4, 3, 84)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height),)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 84)

traj_mean = traj_mouse.mean(0)
traj_sem = traj_mouse.std(0) / np.sqrt(traj_mouse.shape[0])

for i in range(4):
    for k in range(n_comp):
        y_avg = traj_mean[i, k]
        y_sem = traj_sem[i, k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

ax[-1].legend(fontsize=12, frameon=0, loc='best')
ax[-1].text(0.15, 1.0, "n=9", transform=ax[-1].transAxes, ha='right', va='top', fontsize=18)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_73.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = traj_mean[i, :, :66]
    X_sem = traj_sem[i, :, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].fill_between(X_avg[0], X_avg[1] - X_sem[1], X_avg[1] + X_sem[1], color=color[i], alpha=0.2)

    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].fill_between(X_avg[0], X_avg[2] - X_sem[2], X_avg[2] + X_sem[2], color=color[i], alpha=0.2)
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].fill_between(X_avg[1], X_avg[2] - X_sem[2], X_avg[2] + X_sem[2], color=color[i], alpha=0.2)
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

ax[-1].legend(fontsize=12, frameon=0, loc='best')
ax[-1].text(0.15, 1.1, "n=9", transform=ax[-1].transAxes, ha='right', va='top', fontsize=18)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_74.png]]

#+begin_src ipython

#+end_src

#+RESULTS:


** Trajectories

#+begin_src ipython
n_comp = 3
i_mouse = 3
print(options['mice'][i_mouse])
X = np.swapaxes(pca_list[i_mouse], 1, 2)
y = y_trials[i_mouse]
print(X.shape, y.shape)
#+end_src

#+RESULTS:
: JawsM15
: (96, 3, 84) (96, 17)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height),)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 84)

for i in range(4):
    mask = (y.odor_pair==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_77.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = y.tasks.unique()
xtime = np.linspace(0, 14, 84)

for i in range(len(y.tasks.unique())):
    mask = (y.tasks==y.tasks.unique()[i]) # & (y.odor_pair==3)
    X_sel = X[mask]

    X_avg = X_sel.mean(0)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_78.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['A', 'B']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.sample_odor.values==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_79.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['unpair', 'pair']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.pair==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_80.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['nolick', 'lick']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.choice==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_81.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['C', 'D']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.test_odor==i)
    X_sel = X[mask]
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_82.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = (X[(y.odor_pair==i)].mean(0))[:, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_83.png]]

#+begin_src ipython

#+end_src

#+RESULTS:


** Embeddings

#+begin_src ipython
import cmocean
cmap=cmocean.cm.phase

theta = np.arctan2(pcs[0], pcs[1]) * 180 / np.pi
idx = np.argsort(theta)

theta_norm = (theta+ 360) % (360)

counts, bins, patches = plt.hist(theta_norm, bins='auto', range=(0, 360), density=1)

bin_centers = 0.5*(bins[:-1] + bins[1:])
colors = [cmap(center/(360)) for center in bin_centers]

for patch, color in zip(patches, colors):
    patch.set_facecolor(color)

plt.xlabel('Neuron Loc (°)')
plt.ylabel('Density')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_85.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, gaussian_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

size = 0.05

for k in range(n_comp):
    sc = ax[k].scatter(theta[idx], pcs[k][idx], alpha=0.5, c=theta_norm[idx], cmap=cmap)
    ax[k].plot(theta[idx], gaussian_filter1d(pcs[k][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
    ax[k].axhline(0, ls='--', color='k')
    ax[k].set_ylabel('Weights PC %d' % (k+1))
    ax[k].set_xlabel('Neuron Loc (°)')
    ax[k].set_ylim([-z_lim, z_lim])

ax[-1].set_ylim([-z_lim/2, z_lim/2])
plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_86.png]]

#+begin_src ipython
nbins = 30
theta_bins = np.linspace(0, 360, nbins+1)
theta_digitized = np.digitize(theta_norm, theta_bins) - 1

# For each bin, average pcs[0], pcs[1], and pcs[2]
pcs_binned = np.zeros((3, nbins))
for i in range(nbins):
    mask = theta_digitized == i
    for j in range(3):
        pcs_binned[j, i] = np.mean(pcs[j][mask]) if np.any(mask) else np.nan

pcs_smooth = gaussian_filter1d(pcs_binned, sigma=3, axis=1, mode='wrap')
#+end_src

#+RESULTS:

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

for i, ax in enumerate(axs):
    ax.plot(theta_plot * 180 / np.pi, pcs_smooth[i], lw=2)
    ax.axhline(0, ls='--', color='k')
    ax.set_ylabel('Weights PC %d' % (i+1))
    ax.set_xlabel('Neuron Loc (°)')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_88.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

# Compute bin centers in degrees and radians
bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)  # for polar plots

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width), sharey=1)

# PC1 vs PC2
axs[0].plot(pcs_smooth[0], pcs_smooth[1], 'k-')
axs[0].set_xlabel('PC 1')
axs[0].set_ylabel('PC 2')

# PC1 vs PC3
axs[1].plot(pcs_smooth[0], pcs_smooth[2], 'k-')
axs[1].set_xlabel('PC 1')
axs[1].set_ylabel('PC 3')

# PC2 vs PC3
axs[2].plot(pcs_smooth[1], pcs_smooth[2], 'k-')
axs[2].set_xlabel('PC 2')
axs[2].set_ylabel('PC 3')

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_89.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(1, 3, subplot_kw={'polar': True}, figsize=(n_comp*width, width))

for i, ax in enumerate(axs):
    ax.plot(theta_plot, pcs_smooth[i], lw=2)

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_90.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, uniform_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width))

ax[0].scatter(pcs[0][idx], pcs[1][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[0].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')

ax[0].set_xlabel('PC 1')
ax[0].set_ylabel('PC 2')

ax[1].scatter(pcs[0][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[1].plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[1].set_xlabel('PC 1')
ax[1].set_ylabel('PC 3')

sc = ax[2].scatter(pcs[1][idx], pcs[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[2].plot(gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'), gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'), 'k')
ax[2].set_xlabel('PC 2')
ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].set_xlim(-z_lim, z_lim)
    ax[k].set_ylim(-z_lim, z_lim)

plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_91.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(gaussian_filter1d(pcs[0][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[1][idx], int(size*pcs.shape[1]), mode='wrap'),
           gaussian_filter1d(pcs[2][idx], int(size*pcs.shape[1]), mode='wrap'),
           rasterized=1, color='k')


sc = ax.scatter(pcs[0][idx],
                pcs[1][idx],
                pcs[2][idx],
                c=theta_norm[idx], cmap=cmap,
                rasterized=1, alpha=0.5)

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim, z_lim])
ax.set_zlim([-z_lim/10, z_lim/10])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_92.png]]


#+begin_src ipython

#+end_src

#+RESULTS:


** Speed

#+begin_src ipython
print(X.shape)
y_labels = y_trials[i_mouse]
speed = np.abs(np.diff(X, axis=-1))
print(speed.shape)
#+end_src

#+RESULTS:
: (96, 3, 84)
: (96, 3, 83)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 83)

for i in range(4):
    mask = (y_labels.odor_pair==i)
    X_sel = speed[mask]          # Subselect rows
    # X_sel = np.abs(np.diff(X_sel, axis=-1))

    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
        ax[k].set_xlim(2, 10)
        ax[k].set_ylim(0, 0.5)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_95.png]]

#+begin_src ipython
x = X[:, 0, :]  # shape (trials, time)
y = X[:, 1, :]

# Differences along time axis
dx = np.diff(x, axis=-1)
dy = np.diff(y, axis=-1)

# Paired x, y for time intervals
x_mid = x[:, :-1]
y_mid = y[:, :-1]

# Radial distance from origin
radius = np.sqrt(x_mid**2 + y_mid**2)

# Radial speed (project velocity onto unit vector from origin)
radial_speed = (x_mid * dx + y_mid * dy) / radius

# Angle for each time point
angles = np.arctan2(y, x)

angles_unwrapped = np.unwrap(angles, axis=-1)
angular_speed = np.diff(angles_unwrapped, axis=-1)  # in radians per time step
print(radial_speed.shape, angular_speed.shape)
#+end_src

#+RESULTS:
: (96, 83) (96, 83)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=1, figsize=(width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 83)

for i in range(4):
    mask = (y_labels.odor_pair==i)
    X_sel = radial_speed[mask]
    print(X_sel.shape)

    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    ax.plot(xtime, gaussian_filter1d(X_avg, sigma=1), color=color[i], label=pair[i])
    # ax.fill_between(xtime, X_avg-X_sem, X_avg+X_sem, color=color[i], alpha=0.2)
    ax.axhline(0, ls='--', color='k')
    ax.set_xlabel('Time')
    ax.set_ylabel('PC %d' % (k+1))
    add_vlines(ax, if_dpa=1)

    ax.legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
:RESULTS:
: (24, 83)
: (24, 83)
: (24, 83)
: (24, 83)
[[file:./figures/overlaps/figure_97.png]]
:END:

** Flow

#+begin_src ipython
import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import griddata
from scipy.ndimage import gaussian_filter

def polar_velocities(x, y, sigma=1):
    """
    x, y: (n_traj, n_points)
    sigma: gaussian smoothing in time (in points)
    Returns:
      dr_s, dtheta_s: (n_traj, n_points): smoothed radial and angular velocities
      r, theta: positions at each point, for later conversion
    """
    # Polar coords
    r = np.sqrt(x**2 + y**2)
    theta = np.arctan2(y, x)

    # Derivatives
    dr = np.gradient(r, axis=1)
    dtheta = np.gradient(theta, axis=1)

    # Handle angle wrapping
    dtheta = np.unwrap(theta, axis=1)
    dtheta = np.gradient(dtheta, axis=1)

    # Smoothing
    dr_s     = gaussian_filter(dr, sigma=sigma)
    dtheta_s = gaussian_filter(dtheta, sigma=sigma)

    return dr_s, dtheta_s, r, theta

def pol2cart(dr, dtheta, r, theta):
    """
    Converts smoothed polar velocities to Cartesian velocities.
    All arrays shape: (n_traj, n_points)
    """
    u = dr * np.cos(theta) - r * dtheta * np.sin(theta)
    v = dr * np.sin(theta) + r * dtheta * np.cos(theta)
    return u, v

def create_field(x, y, u, v, grid_size=100, method='linear'):
    """
    Interpolate velocity field to a regular grid.
    Inputs: x,y,u,v all (n_samples,) or (n_traj, n_points) -- flatten them first.
    Returns: xi, yi, ui, vi: all (grid_size, grid_size) arrays.
    """
    x_flat = x.flatten()
    y_flat = y.flatten()
    u_flat = u.flatten()
    v_flat = v.flatten()

    # xi, yi = np.meshgrid(
    #     np.linspace(np.min(x_flat), np.max(x_flat), grid_size),
    #     np.linspace(np.min(y_flat), np.max(y_flat), grid_size),
    # )

    x_min, x_max = np.min(x_flat)-1, np.max(x_flat)+1
    y_min, y_max = np.min(y_flat)-1, np.max(y_flat)+1

    z_min = np.min((x_min, y_min))
    z_max = np.min((x_max, y_max))

    xi, yi = np.meshgrid(np.linspace(z_min, z_max, grid_size),
                         np.linspace(z_min, z_max, grid_size))


    ui = griddata((x_flat, y_flat), u_flat, (xi, yi), method=method, fill_value=np.nan)
    vi = griddata((x_flat, y_flat), v_flat, (xi, yi), method=method, fill_value=np.nan)

    # Fill nans with nearest
    mask = np.isnan(ui)
    if np.any(mask):
        ui[mask] = griddata((x_flat, y_flat), u_flat, (xi, yi), method='nearest')[mask]
        vi[mask] = griddata((x_flat, y_flat), v_flat, (xi, yi), method='nearest')[mask]

    return xi, yi, ui, vi

def plot_field(xi, yi, ui, vi, ax=None, density=1.0, show_cbar=0):
    speed = np.sqrt(ui**2 + vi**2)
    if ax is None:
        fig, ax = plt.subplots(figsize=(5,5))
    # Normalize for coloring
    import matplotlib as mpl
    vmin, vmax = np.nanpercentile(speed, [5, 95])
    norm = mpl.colors.Normalize(vmin, vmax)
    strm = ax.streamplot(xi, yi, ui, vi, density=density, color=speed, cmap='coolwarm', norm=norm)
    if show_cbar:
        plt.colorbar(strm.lines, ax=ax, label='Speed')
    ax.set_aspect('equal')
    ax.set_xlabel('x')
    ax.set_ylabel('y')
    return ax
#+end_src

#+RESULTS:

#+begin_src ipython
n_comp = 3
i_mouse = 3
X = np.swapaxes(pca_list[i_mouse], 1, 2)
y_labels = y_trials[i_mouse]
print(X.shape, y.shape)
#+end_src

#+RESULTS:
: (96, 3, 84) (96, 84)

#+begin_src ipython
idx = (y_labels.test_odor==0)

X_delay = X[idx]
X_delay = X_delay[:, :2, options['bins_TEST']]

x = X_delay[:,0,:]
y = X_delay[:,1,:]

# 1. Polar smoothing
dr_s, dtheta_s, r, theta = polar_velocities(x, y, sigma=3)

# 2. Map back to Cartesian velocities
u, v = pol2cart(dr_s, dtheta_s, r, theta)

# 3. Interpolate to grid
xi, yi, ui, vi = create_field(x, y, u, v, grid_size=32, method='linear')

# 4. Plot
fig, ax = plt.subplots(figsize=(width, width))
plot_field(xi, yi, ui, vi, ax=ax)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_100.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

* CV Meta Model
** Data

#+begin_src ipython
X_trials, y_trials = [], []

n_neurons = 3319
counter = 0
for mouse in options['mice']:

    options['mouse'] = mouse
    options = set_options(**options)
    X, y = get_X_y_days(**options)
    print(mouse, X.shape, y.shape, options['n_days'])

    X_trial = np.zeros((X.shape[0], n_neurons, X.shape[-1]))
    X_trial[:, counter:X.shape[1]+counter, :] = X

    counter += X.shape[1]

    X_trials.append(X_trial)

    y['mouse'] = mouse
    y_trials.append(y)

X_trials = np.array(X_trials, dtype=object)
y_trials = np.array(y_trials, dtype=object)
#+end_src

#+RESULTS:
: JawsM01 (768, 184, 84) (768, 15) 4
: JawsM06 (1152, 201, 84) (1152, 15) 6
: JawsM12 (960, 423, 84) (960, 15) 5
: JawsM15 (1152, 693, 84) (1152, 15) 6
: JawsM18 (1152, 444, 84) (1152, 15) 6
: ChRM04 (1152, 668, 84) (1152, 15) 6
: ChRM23 (960, 232, 84) (960, 15) 5
: ACCM03 (960, 361, 84) (960, 15) 5
: ACCM04 (960, 113, 84) (960, 15) 5

#+begin_src ipython
X_all = np.concatenate(X_trials, 0)
y_all = pd.concat(y_trials)
print(X_all.shape, y_all.shape)
#+end_src

#+RESULTS:
: (9216, 3319, 84) (9216, 16)

#+begin_src ipython
print(y_all.response.unique())
#+end_src

#+RESULTS:
: ['correct_hit' 'incorrect_fa' 'correct_rej' 'incorrect_miss']

#+begin_src ipython
pkl_save(X_all, 'X_all', path="../data/pca/")
pkl_save(y_all, 'y_all', path="../data/pca/")
#+end_src

#+RESULTS:
: saving to ../data/pca//X_all.pkl
: saving to ../data/pca//y_all.pkl

** Model

#+begin_src ipython
X_all = pkl_load('X_all', path="../data/pca/")
y_all = pkl_load('y_all', path="../data/pca/")
#+end_src

#+RESULTS:
: loading from ../data/pca//X_all.pkl
: loading from ../data/pca//y_all.pkl

#+begin_src ipython
from sklearn.model_selection import StratifiedKFold
from sklearn.decomposition import PCA
from tqdm import tqdm
from tqdm_joblib import tqdm_joblib

from joblib import Parallel, delayed
import numpy as np
import pandas as pd

def process_fold(train_idx, test_idx, X, y, n_comp, epoch, condition):
    pca = PCA(n_components=n_comp)
    scaler = StandardScaler()

    X_train, X_test = X[train_idx], X[test_idx]

    # Fit scaler and transform train
    X_train = scaler.fit_transform(X_train)
    # User-supplied function
    X_avg = cv_avg_cond(X_train, y.iloc[train_idx].copy(), condition)

    X_flat = X_avg[..., epoch].transpose(0, 2, 1).reshape(-1, X_avg.shape[1])

    X_mean = np.nanmean(X_flat, 0, keepdims=1)
    X_cent = (X_flat - X_mean)

    pca.fit(X_cent)
    w_fold = pca.components_
    evr_fold = pca.explained_variance_ratio_

    # Test fold
    X_test_scaled = scaler.transform(X_test)
    y_test = y.iloc[test_idx]

    X_flat = X_test_scaled.transpose(0, 2, 1).reshape(-1, X_test_scaled.shape[1])
    X_mean = np.nanmean(X_flat, 0, keepdims=1)
    X_cent = (X_flat - X_mean)
    X_pca = pca.transform(X_cent).reshape(X_test_scaled.shape[0], X_test_scaled.shape[-1], -1)

    return X_pca, y_test.copy(), w_fold, evr_fold



def par_cross_val_avg_pca(X, y, n_splits, n_comp, epoch, condition, n_jobs=-1):

    kf = StratifiedKFold(n_splits=n_splits, shuffle=True)
    labels = y['mouse'].astype(str) + '_' + y['odor_pair'].astype(str) + '_' + y['tasks'].astype(str)

    fold_args = list(kf.split(X, labels))

    # with tqdm_joblib(tqdm(desc="PCA folds", total=len(fold_args))) as progress_bar:
    #     results = Parallel(n_jobs=n_jobs)(
    #         delayed(process_fold)(train_idx, test_idx, X, y, n_comp, epoch, condition)
    #         for train_idx, test_idx in fold_args
    # )

    results = Parallel(n_jobs=n_jobs)(
        delayed(process_fold)(train_idx, test_idx, X, y, n_comp, epoch, condition)
        for train_idx, test_idx in fold_args
    )

    X_folds, y_folds, w_folds, evr_folds = zip(*results)
    X_folds = np.concatenate(X_folds, axis=0)
    y_folds = pd.concat(y_folds)
    w_folds = np.array(w_folds, dtype=object)
    evr_folds = np.array(evr_folds, dtype=object)
    return X_folds, y_folds, w_folds, evr_folds
#+end_src

#+RESULTS:

#+begin_src ipython
import numpy as np
import itertools
from functools import reduce
import operator

def cv_avg_cond(X, y, condition='odor_pair'):
    # Ensure condition is a list
    if isinstance(condition, str):
        condition = [condition]

    # Find unique values for each condition
    unique_vals = [y[c].unique() for c in condition]

    X_avg = []
    combos = list(itertools.product(*unique_vals))
    for combo in combos:
        # Build boolean mask for all conditions
        idx = reduce(operator.and_, [(y[c]==v) for c,v in zip(condition, combo)])
        if idx.any():
            X_avg.append(np.mean(X[idx], axis=0))

    return np.array(X_avg)
#+end_src

#+RESULTS:

#+begin_src ipython
from sklearn.model_selection import KFold, StratifiedKFold
from sklearn.decomposition import PCA
from tqdm import tqdm

def cross_val_avg_pca(X, y, n_splits, n_comp, epoch, condition):

    scaler = StandardScaler(axis=0)
    pca = PCA(n_components=n_comp)

    kf = StratifiedKFold(n_splits=n_splits, shuffle=True)
    labels = y['mouse'].astype(str) + '_' + y['odor_pair'].astype(str) + '_' + y['tasks'].astype(str)

    X_folds, y_folds = [], []
    w_folds, evr_folds = [], []
    for train_idx, test_idx in tqdm(kf.split(X, labels), total=kf.get_n_splits(X, labels)):

        X_train, X_test = X[train_idx], X[test_idx]

        X_train = scaler.fit_transform(X_train)
        X_avg = cv_avg_cond(X_train, y.iloc[train_idx].copy(), condition)

        X_flat = X_avg[..., epoch].transpose(0, 2, 1).reshape(-1, X_avg.shape[1])

        X_mean = np.nanmean(X_flat, 0, keepdims=1)
        X_cent = (X_flat - X_mean)

        pca.fit(X_cent)
        w_folds.append(pca.components_)
        evr_folds.append(pca.explained_variance_ratio_)

        X_test = scaler.transform(X_test)
        y_test = y.iloc[test_idx]

        X_flat = X_test.transpose(0, 2, 1).reshape(-1, X_test.shape[1])
        X_mean = np.nanmean(X_flat, 0, keepdims=1)
        X_cent = (X_flat - X_mean)
        X_pca = pca.transform(X_cent).reshape(X_test.shape[0], X_test.shape[-1], -1)

        X_folds.append(X_pca)
        y_folds.append(y_folds.append(y.iloc[test_idx].copy()))

    X_folds = np.concatenate(X_folds, 0)
    y_folds = pd.concat(y_folds)

    w_folds = np.array(w_folds, dtype=object)
    evr_folds = np.array(evr_folds, dtype=object)

    return X_folds, y_folds, w_folds, evr_folds
#+end_src

#+RESULTS:

#+begin_src ipython
options['learning'] = 'Expert'

options['epochs'] = ['TEST']
epoch = options['bins_' + options['epochs'][0]]
condition = 'odor_pair'

idx = (y_all.learning == options['learning']) & (y_all.laser==0) # & (y_all.performance==1) & ((y_all.tasks=='DPA') | (y_all.odr_perf==1))

X = X_all[idx]
y = y_all[idx]

print(X.shape, y.shape)
print(y.mouse.unique())
print(y.odor_pair.unique())
print(y.tasks.unique())
#+end_src

#+RESULTS:
: (2400, 3319, 84) (2400, 16)
: ['JawsM01' 'JawsM06' 'JawsM12' 'JawsM15' 'JawsM18' 'ChRM04' 'ChRM23'
:  'ACCM03' 'ACCM04']
: [1. 2. 0. 3.]
: ['DualNoGo' 'DualGo' 'DPA']

#+begin_src ipython
pca = PCA(n_components=3)
scaler = StandardScaler(axis=0)

# fit on full data
X_scaled = scaler.fit_transform(X)
X_avg = cv_avg_cond(X_scaled, y.copy(), condition)
X_flat = X_avg[..., epoch].transpose(0, 2, 1).reshape(-1, X_avg.shape[1])
X_mean = np.nanmean(X_flat, 0, keepdims=1)
X_cent = (X_flat - X_mean)

# pca.fit(X_cent)
# w_all = pca.components_
# evr_all = pca.explained_variance_ratio_

X_flat = X_scaled.transpose(0, 2, 1).reshape(-1, X_scaled.shape[1])
X_mean = np.nanmean(X_flat, 0, keepdims=1)
X_cent = (X_flat - X_mean)

# X_pca = pca.transform(X_cent).reshape(X_scaled.shape[0], X_scaled.shape[-1], -1)
#+end_src

#+RESULTS:
: 1b9d2d6f-a15e-4644-8c53-fdd0e21ae0ba

#+begin_src ipython
print(w_all.shape, evr_all.shape)
#+end_src

#+RESULTS:
: df3a5aad-9d37-437e-aec2-c6e58ce8fbae

#+begin_src ipython
n_splits = 10
n_comp = 3
X_cv, y_cv, w_cv, evr_cv = cross_val_avg_pca(X, y, n_splits, n_comp, epoch, condition)
#+end_src

#+RESULTS:
: 100% 10/10 [18:13<00:00, 109.36s/it]

#+begin_src ipython
print(X_cv.shape, y_cv.shape, w_cv.shape, evr_cv.shape)
#+end_src

#+RESULTS:
: (2400, 84, 3) (2400, 16) (10, 3, 3319) (10, 3)

** save/load

#+begin_src ipython
dum = options['epochs'][0] + '_' + options['learning'] + '_all'

pkl_save(X_cv, 'cv_traj_' + dum, path="../data/pca/")
pkl_save(y_cv, 'cv_labels_' + dum, path="../data/pca/")
pkl_save(w_cv, 'cv_weights_' + dum, path="../data/pca/")
pkl_save(evr_cv, 'cv_evr_' + dum, path="../data/pca/")
#+end_src

#+RESULTS:
: saving to ../data/pca//cv_traj_TEST_Expert_all.pkl
: saving to ../data/pca//cv_labels_TEST_Expert_all.pkl
: saving to ../data/pca//cv_weights_TEST_Expert_all.pkl
: saving to ../data/pca//cv_evr_TEST_Expert_all.pkl

#+begin_src ipython
X_cv = pkl_load('cv_traj_' + dum, path="../data/pca/")
y_cv = pkl_load( 'cv_labels_' + dum, path="../data/pca/")
w_cv = pkl_load( 'cv_weights_' + dum, path="../data/pca/")
evr_cv = pkl_load( 'cv_evr_' + dum, path="../data/pca/")
#+end_src

#+RESULTS:
: loading from ../data/pca//cv_traj_TEST_Expert_all.pkl
: loading from ../data/pca//cv_labels_TEST_Expert_all.pkl
: loading from ../data/pca//cv_weights_TEST_Expert_all.pkl
: loading from ../data/pca//cv_evr_TEST_Expert_all.pkl

#+begin_src ipython
X_pca = np.array(X_cv, dtype=float)
X = np.swapaxes(X_pca, 1, 2)
y = y_cv
w = np.mean(w_cv, 0, dtype=float) * 100
# w = w_all * 100
print(X.shape, y.shape, w.shape)
#+end_src

#+RESULTS:
: (2400, 3, 84) (2400, 16) (3, 3319)

** Trajectories

#+begin_src ipython
n_comp = 3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height),)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 84)

for i in range(4):
    mask = (y.odor_pair==i)
    X_sel = X[mask]

    X_avg = np.mean(X_sel, 0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = np.std(X_sel, 0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_111.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = y.tasks.unique()
xtime = np.linspace(0, 14, 84)

for i in range(len(y.tasks.unique())):
    mask = (y.tasks==y.tasks.unique()[i]) # & (y.odor_pair==3)
    X_sel = X[mask]

    X_avg = X_sel.mean(0)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_112.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['A', 'B']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.sample_odor.values==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_113.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#4daf4a", "#ffae19"]

pair = ['unpair', 'pair']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.pair==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_114.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#4daf4a"]

pair = ['nolick', 'lick']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.choice==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_115.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#4daf4a"]

pair = ['C', 'D']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.test_odor==i)
    X_sel = X[mask]
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_116.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = (X[(y.odor_pair==i)].mean(0))[:, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_117.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Embeddings
*** spatial filter

#+begin_src ipython
z_lim =5
size = 0.05

import cmocean
cmap=cmocean.cm.phase

theta = np.arctan2(w[1], w[0]) * 180 / np.pi
idx = np.argsort(theta)

theta_norm = (theta+ 360) % (360)

counts, bins, patches = plt.hist(theta_norm, bins='auto', range=(0, 360), density=1)

bin_centers = 0.5*(bins[:-1] + bins[1:])
colors = [cmap(center/(360)) for center in bin_centers]

for patch, color in zip(patches, colors):
    patch.set_facecolor(color)

plt.xlabel('Neuron Loc (°)')
plt.ylabel('Density')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_119.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, gaussian_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

for k in range(n_comp):
    sc = ax[k].scatter(theta[idx], w[k][idx], alpha=0.5, c=theta_norm[idx], cmap=cmap, rasterized=1)
    ax[k].plot(theta[idx], gaussian_filter1d(w[k][idx], int(size*w.shape[1]), mode='wrap'), 'k')
    ax[k].axhline(0, ls='--', color='k')
    ax[k].set_ylabel('Weights PC %d' % (k+1))
    ax[k].set_xlabel('Neuron Loc (°)')
    ax[k].set_ylim([-z_lim, z_lim])

ax[-1].set_ylim([-z_lim/5, z_lim/5])
plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_120.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, uniform_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width))

ax[0].scatter(w[0][idx], w[1][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5, rasterized=1)
ax[0].plot(gaussian_filter1d(w[0][idx], int(size*w.shape[1]), mode='wrap'), gaussian_filter1d(w[1][idx], int(size*w.shape[1]), mode='wrap'), 'k')

ax[0].set_xlabel('PC 1')
ax[0].set_ylabel('PC 2')

ax[1].scatter(w[0][idx], w[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5, rasterized=1)
ax[1].plot(gaussian_filter1d(w[0][idx], int(size*w.shape[1]), mode='wrap'), gaussian_filter1d(w[2][idx], int(size*w.shape[1]), mode='wrap'), 'k')
ax[1].set_xlabel('PC 1')
ax[1].set_ylabel('PC 3')

sc = ax[2].scatter(w[1][idx], w[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5, rasterized=1)
ax[2].plot(gaussian_filter1d(w[1][idx], int(size*w.shape[1]), mode='wrap'), gaussian_filter1d(w[2][idx], int(size*w.shape[1]), mode='wrap'), 'k')
ax[2].set_xlabel('PC 2')
ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].set_xlim(-z_lim, z_lim)
    ax[k].set_ylim(-z_lim, z_lim)

plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_121.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(gaussian_filter1d(w[0][idx], int(size*w.shape[1]), mode='wrap'),
           gaussian_filter1d(w[1][idx], int(size*w.shape[1]), mode='wrap'),
           gaussian_filter1d(w[2][idx], int(size*w.shape[1]), mode='wrap'),
           rasterized=1, color='k')


sc = ax.scatter(w[0][idx],
                w[1][idx],
                w[2][idx],
                c=theta_norm[idx], cmap=cmap,
                rasterized=1, alpha=0.5)

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim, z_lim])
ax.set_zlim([-z_lim/10, z_lim/10])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_122.png]]

*** theta space

#+begin_src ipython
nbins = 360 // 8
theta_bins = np.linspace(0, 360, nbins+1)
theta_digitized = np.digitize(theta_norm, theta_bins) - 1

# For each bin, average w[0], w[1], and w[2]
w_binned = np.zeros((3, nbins))
for i in range(nbins):
    mask = theta_digitized == i
    for j in range(3):
        w_binned[j, i] = np.mean(w[j][mask]) if np.any(mask) else np.nan


w_smooth = gaussian_filter1d(w_binned, sigma=2, axis=1, mode='wrap')
# w_smooth = uniform_filter1d(w_binned, size=100, axis=1, mode='wrap')
#+end_src

#+RESULTS:

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

for i, ax in enumerate(axs):
    ax.plot(theta_plot * 180 / np.pi, w_smooth[i], lw=2)
    ax.axhline(0, ls='--', color='k')
    ax.set_ylabel('Weights PC %d' % (i+1))
    ax.set_xlabel('Neuron Loc (°)')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_124.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

# Compute bin centers in degrees and radians
bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)  # for polar plots

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width), sharey=1)

# PC1 vs PC2
axs[0].plot(w_smooth[0], w_smooth[1], 'k-')
axs[0].set_xlabel('PC 1')
axs[0].set_ylabel('PC 2')

# PC1 vs PC3
axs[1].plot(w_smooth[0], w_smooth[2], 'k-')
axs[1].set_xlabel('PC 1')
axs[1].set_ylabel('PC 3')

# PC2 vs PC3
axs[2].plot(w_smooth[1], w_smooth[2], 'k-')
axs[2].set_xlabel('PC 2')
axs[2].set_ylabel('PC 3')

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_125.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(1, 3, subplot_kw={'polar': True}, figsize=(n_comp*width, width))

for i, ax in enumerate(axs):
    ax.plot(theta_plot, w_smooth[i], lw=2)

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_126.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Energy

#+begin_src ipython
traj_mouse = []
for i_mouse, mouse in enumerate(options['mice']):
    idx = (y.mouse==mouse)
    X_idx = X[idx]
    y_idx = y[idx]

    mask = (y_idx.tasks=='DPA')
    traj_ = X_idx[mask]

    traj_mouse.append(traj_)

traj_mouse = np.array(traj_mouse, dtype=object)
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (9,)

#+begin_src ipython
from src.attractor.landscape import EnergyLandscape
energy = EnergyLandscape(IF_HMM=0)

num_bins = 360 // 8
window = 2

bins = np.linspace(0, 2*np.pi, num_bins, endpoint=False)
print(bins.shape)
#+end_src

#+RESULTS:
: (45,)

#+begin_src ipython
landscapes = []
for i in range(traj_mouse.shape[0]):
    traj = traj_mouse[i]
    try:
        phi = (np.arctan2(traj[1], traj[0]) - np.pi) % (2* np.pi)
        # landscape = energy.fit(phi[:,:options['bins_DELAY'][-1]], bins, window=window)
        landscape = energy.fit(phi[..., options['bins_DELAY']], bins, window=window)
        landscapes.append(landscape)
        plt.plot(bins[:-1] * 180 / np.pi, landscape, alpha=0.25)
    except:
        pass

plt.plot(bins[:-1] * 180 / np.pi, np.nanmean(landscapes, 0), 'k')
plt.axvline(0)
plt.axvline(180)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_130.png]]

#+begin_src ipython
angles = bins[:-1]
energies = np.nanmean(landscapes, 0)

# Append first point to end to close the curve
angles_wrapped = np.append(angles, angles[0])
energies_wrapped = np.append(energies, energies[0])

fig, ax = plt.subplots(subplot_kw={'projection': 'polar'})
ax.plot(angles_wrapped, energies_wrapped, 'k')
ax.grid(False)
ax.set_yticklabels([])
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_131.png]]


#+begin_src ipython

#+end_src

#+RESULTS:

** Opto

#+begin_src ipython
dum = options['epochs'][0] + '_' + options['learning']
X_cv = pkl_load('cv_traj_' + dum, path="../data/pca/")
y_cv = pkl_load( 'cv_labels_' + dum, path="../data/pca/")
X_pca = np.array(X_cv, dtype=float)
X = np.swapaxes(X_pca, 1, 2)
y = y_cv
#+end_src

#+RESULTS:
: loading from ../data/pca//cv_traj_TEST_Expert.pkl
: loading from ../data/pca//cv_labels_TEST_Expert.pkl

#+begin_src ipython
dum = options['epochs'][0] + '_' + options['learning'] + '_laser'

X_laser = pkl_load('cv_traj_' + dum, path="../data/pca/")
y_laser = pkl_load( 'cv_labels_' + dum, path="../data/pca/")
X_pca = np.array(X_laser, dtype=float)
X_laser = np.swapaxes(X_pca, 1, 2)
y_laser = y_laser
#+end_src

#+RESULTS:
: loading from ../data/pca//cv_traj_TEST_Expert_laser.pkl
: loading from ../data/pca//cv_labels_TEST_Expert_laser.pkl

#+begin_src ipython
traj_mouse = []
for i_mouse, mouse in enumerate(options['mice']):
    idx = (y.mouse==mouse)
    X_idx = X[idx]
    y_idx = y[idx]

    traj_ = []
    for i in range(2):
        mask = (y_idx.sample_odor==i) & (y_idx.tasks=='DPA')
        traj_.append(X_idx[mask].mean(0))

    traj_mouse.append(traj_)

traj_mouse = np.array(traj_mouse)
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (9, 2, 3, 84)

#+begin_src ipython
traj_opto = []
for i_mouse, mouse in enumerate(options['mice']):
    idx = (y_laser.mouse==mouse)
    X_idx = X_laser[idx]
    y_idx = y_laser[idx]

    traj_ = []
    for i in range(2):
        mask = (y_idx.sample_odor==i) & (y_idx.tasks=='DPA')
        traj_.append(X_idx[mask].mean(0))

    traj_opto.append(traj_)

traj_opto = np.array(traj_opto)
print(traj_opto.shape)
#+end_src

#+RESULTS:
: (9, 2, 3, 84)

#+begin_src ipython
fp_mouse = np.nanmean(traj_mouse[..., options['bins_LD']], -1)
fp_opto = np.nanmean(traj_opto[..., options['bins_LD']], -1)

pc1 = fp_mouse[..., 0]
pc2 = fp_mouse[..., 1]

pc1_opto = fp_opto[..., 0]
pc2_opto = fp_opto[..., 1]
#+end_src

#+RESULTS:

#+begin_src ipython
for i in range(pc1.shape[0]):
    plt.scatter(pc2[i], pc2_opto[i], label=options['mice'][i])
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_135.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=2, figsize=(2*width, height), sharey=1)

for i in range(pc1.shape[0]):
    ax[0].scatter(pc1[i], pc2[i], label=options['mice'][i])
    ax[1].scatter(pc1_opto[i], pc2_opto[i], label=options['mice'][i])

for k in range(2):
    ax[k].axvline(0, color='k')
    ax[k].axhline(0, color='k')

    ax[k].set_xlabel('PC1')
    ax[k].set_xlabel('PC2')
# plt.legend(fontsize=12, frameon=0)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_136.png]]

#+begin_src ipython
perf = y.groupby(['mouse', 'sample_odor'])['performance'].mean().reset_index()
perf_on = y_laser.groupby(['mouse', 'sample_odor'])['performance'].mean().reset_index()
#+end_src

#+RESULTS:
#+begin_example
      mouse  sample_odor  performance
0    ACCM03          0.0          1.0
1    ACCM03          1.0          1.0
2    ACCM04          0.0          1.0
3    ACCM04          1.0          1.0
4    ChRM04          0.0          1.0
5    ChRM04          1.0          1.0
6    ChRM23          0.0          1.0
7    ChRM23          1.0          1.0
8   JawsM01          0.0          1.0
9   JawsM01          1.0          1.0
10  JawsM06          0.0          1.0
11  JawsM06          1.0          1.0
12  JawsM12          0.0          1.0
13  JawsM12          1.0          1.0
14  JawsM15          0.0          1.0
15  JawsM15          1.0          1.0
16  JawsM18          0.0          1.0
17  JawsM18          1.0          1.0
#+end_example



** Mouse average trajectories

#+begin_src ipython
traj_mouse = []
for i_mouse, mouse in enumerate(options['mice']):
    idx = (y.mouse==mouse)
    X_idx = X[idx]
    y_idx = y[idx]
    # print(mouse, X_idx.shape, y_idx.shape)
    traj_ = []
    for i in range(4):
        mask = (y_idx.odor_pair==i)
        traj_.append(X_idx[mask].mean(0))

    traj_mouse.append(traj_)

traj_mouse = np.array(traj_mouse)
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (9, 4, 3, 84)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 84)

traj_mean = np.nanmean(traj_mouse, 0)
traj_sem = np.nanstd(traj_mouse, 0) / np.sqrt(traj_mouse.shape[0])

for i in range(4):
    for k in range(n_comp):
        y_avg = traj_mean[i, k]
        y_sem = traj_sem[i, k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

ax[-1].legend(fontsize=12, frameon=0, loc='best')
ax[-1].text(0.15, 1.0, "n=9", transform=ax[-1].transAxes, ha='right', va='top', fontsize=18)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_126.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = traj_mean[i, :, :66]
    X_sem = traj_sem[i, :, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].fill_between(X_avg[0], X_avg[1] - X_sem[1], X_avg[1] + X_sem[1], color=color[i], alpha=0.2)

    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].fill_between(X_avg[0], X_avg[2] - X_sem[2], X_avg[2] + X_sem[2], color=color[i], alpha=0.2)
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].fill_between(X_avg[1], X_avg[2] - X_sem[2], X_avg[2] + X_sem[2], color=color[i], alpha=0.2)
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

ax[-1].legend(fontsize=12, frameon=0, loc='best')
ax[-1].text(0.15, 1.1, "n=9", transform=ax[-1].transAxes, ha='right', va='top', fontsize=18)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_127.png]]

#+begin_src ipython
tasks = ['DPA', 'DualGo', 'DualNoGo']
traj_mouse = []
for i_mouse, mouse in enumerate(options['mice']):
    idx = (y.mouse==mouse)
    X_idx = X[idx]
    y_idx = y[idx]

    traj_ = []
    for i in range(3):
        mask = (y_idx.tasks==tasks[i])
        traj_.append(X_idx[mask].mean(0))

    traj_mouse.append(traj_)

traj_mouse = np.array(traj_mouse)
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (9, 3, 3, 84)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['DPA', 'Go', 'NoGo']
xtime = np.linspace(0, 14, 84)

traj_mean = np.nanmean(traj_mouse, 0)
traj_sem = np.nanstd(traj_mouse, 0) / np.sqrt(traj_mouse.shape[0])

for i in range(3):
    for k in range(n_comp):
        y_avg = traj_mean[i, k]
        y_sem = traj_sem[i, k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

ax[-1].legend(fontsize=12, frameon=0, loc='best')
ax[-1].text(0.15, 1.0, "n=9", transform=ax[-1].transAxes, ha='right', va='top', fontsize=18)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_129.png]]

#+RESULTS:

#+begin_src ipython
traj_mouse = []
for i_mouse, mouse in enumerate(options['mice']):
    idx = (y.mouse==mouse)
    X_idx = X[idx]
    y_idx = y[idx]

    traj_ = []
    for i in range(2):
        mask = (y_idx.sample_odor==i) & (y_idx.tasks=='DPA')
        traj_.append(X_idx[mask].mean(0))

    traj_mouse.append(traj_)

traj_mouse = np.array(traj_mouse)
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (9, 2, 3, 84)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['A', 'B']
xtime = np.linspace(0, 14, 84)

traj_mean = np.nanmean(traj_mouse, 0)
traj_sem = np.nanstd(traj_mouse, 0) / np.sqrt(traj_mouse.shape[0])

for i in range(2):
    for k in range(n_comp):
        y_avg = traj_mean[i, k]
        y_sem = traj_sem[i, k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

ax[-1].legend(fontsize=12, frameon=0, loc='best')
ax[-1].text(0.15, 1.0, "n=9", transform=ax[-1].transAxes, ha='right', va='top', fontsize=18)
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_131.png]]

#+begin_src ipython
fp_mouse = np.nanmean(traj_mouse[..., options['bins_LD']], -1)

x = fp_mouse[..., 0]
y = fp_mouse[..., 1]

for i in range(x.shape[0]):
    plt.scatter(x[i], y[i], label=options['mice'][i])

plt.axvline(0, color='k')
plt.axhline(0, color='k')

plt.xlabel('PC1')
plt.xlabel('PC2')
plt.legend(fontsize=12, frameon=0)
plt.show()
#+end_src

#+RESULTS:
:RESULTS:
: (9, 2, 3, 84)
[[file:./figures/overlaps/figure_132.png]]
:END:

#+begin_src ipython
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (9, 2, 3, 84)


#+begin_src ipython
traj_mouse = []
for i_mouse, mouse in enumerate(options['mice']):
    idx = (y.mouse==mouse)
    X_idx = X[idx]
    y_idx = y[idx]

    traj_ = []
    for i in range(2):
        mask = (y_idx.test_odor==i)
        traj_.append(X_idx[mask].mean(0))

    traj_mouse.append(traj_)

traj_mouse = np.array(traj_mouse)
print(traj_mouse.shape)
#+end_src

#+RESULTS:
: (9, 2, 3, 84)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['C', 'D']
xtime = np.linspace(0, 14, 84)

traj_mean = np.nanmean(traj_mouse, 0)
traj_sem = np.nanstd(traj_mouse, 0) / np.sqrt(traj_mouse.shape[0])

for i in range(2):
    for k in range(n_comp):
        y_avg = traj_mean[i, k]
        y_sem = traj_sem[i, k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

ax[-1].legend(fontsize=12, frameon=0, loc='best')
ax[-1].text(0.15, 1.0, "n=9", transform=ax[-1].transAxes, ha='right', va='top', fontsize=18)
plt.show()
#+end_src

** Speed

#+begin_src ipython
idx = y_cv.tasks=='DPA'
y_ = y_cv[idx]
speed = np.abs(np.diff(X[idx], axis=-1))
print(speed.shape)
#+end_src

#+RESULTS:
: (700, 3, 83)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 83)

for i in range(4):
    mask = (y_.odor_pair==i)
    X_sel = speed[mask]          # Subselect rows
    # X_sel = np.abs(np.diff(X_sel, axis=-1))

    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_130.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=1, figsize=(width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

xtime = np.linspace(0, 14, 83)

X_avg = speed.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
X_sem = speed.std(0) / np.sqrt(speed.shape[0])  # SEM

for k in range(n_comp):
    y_avg = X_avg[k]
    y_sem = X_sem[k]
    ax.plot(xtime, y_avg, color=color[k], label='PC %d' %k)
    ax.fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[k], alpha=0.2)
    ax.axhline(0, ls='--', color='k')
    ax.set_xlabel('Time')
    ax.set_ylabel('Speed')
    add_vlines(ax, if_dpa=0)

    ax.legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_131.png]]

#+begin_src ipython
x = X[idx, 0, :]  # shape (trials, time)
y = X[idx, 1, :]

# Differences along time axis
dx = np.diff(x, axis=-1)
dy = np.diff(y, axis=-1)

# Paired x, y for time intervals
x_mid = x[:, :-1]
y_mid = y[:, :-1]

# Radial distance from origin
radius = np.sqrt(x_mid**2 + y_mid**2)

# Radial speed (project velocity onto unit vector from origin)
radial_speed = (x_mid * dx + y_mid * dy) / radius

# Angle for each time point
angles = np.arctan2(y, x)

angles_unwrapped = np.unwrap(angles, axis=-1)
angular_speed = np.diff(angles_unwrapped, axis=-1)  # in radians per time step
print(radial_speed.shape, angular_speed.shape)
#+end_src

#+RESULTS:
: (700, 83) (700, 83)

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=1, figsize=(width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 83)

for i in range(4):
    mask = (y_.odor_pair==i)
    X_sel = radial_speed[mask]

    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    ax.plot(xtime, gaussian_filter1d(X_avg, sigma=1), color=color[i], label=pair[i])
    # ax.fill_between(xtime, X_avg-X_sem, X_avg+X_sem, color=color[i], alpha=0.2)
    ax.axhline(0, ls='--', color='k')
    ax.set_xlabel('Time')
    ax.set_ylabel('Radial')
    add_vlines(ax, if_dpa=1)

    ax.legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_133.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=1, figsize=(width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 83)

for i in range(4):
    mask = (y_.odor_pair==i)
    X_sel = angular_speed[mask]

    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    ax.plot(xtime, gaussian_filter1d(X_avg, sigma=5), color=color[i], label=pair[i])
    # ax.fill_between(xtime, X_avg-X_sem, X_avg+X_sem, color=color[i], alpha=0.2)
    ax.axhline(0, ls='--', color='k')
    ax.set_xlabel('Time')

    add_vlines(ax, if_dpa=1)

    ax.legend(fontsize=12, frameon=0, loc='best')
ax.set_ylabel('Angular')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_134.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=1, figsize=(width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 83)

X_sel = radial_speed
X_avg = X_sel.mean(0)
X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])

ax.plot(xtime, gaussian_filter1d(X_avg, sigma=1), color=color[0], label='radial')

X_sel = angular_speed
X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

ax.plot(xtime, gaussian_filter1d(X_avg, sigma=1), color=color[2], label='angular')

# ax.fill_between(xtime, X_avg-X_sem, X_avg+X_sem, color=color[i], alpha=0.2)
ax.axhline(0, ls='--', color='k')
ax.set_xlabel('Time')
ax.set_ylabel('Speed')
add_vlines(ax, if_dpa=1)

ax.legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_135.png]]

** Flow

#+begin_src ipython
import numpy as np
import matplotlib.pyplot as plt
from scipy.interpolate import griddata
from scipy.ndimage import gaussian_filter

def polar_velocities(x, y, sigma=1):
    """
    x, y: (n_traj, n_points)
    sigma: gaussian smoothing in time (in points)
    Returns:
      dr_s, dtheta_s: (n_traj, n_points): smoothed radial and angular velocities
      r, theta: positions at each point, for later conversion
    """
    # Polar coords
    r = np.sqrt(x**2 + y**2)
    theta = np.arctan2(y, x)

    # Derivatives
    dr = np.gradient(r, axis=1)
    dtheta = np.gradient(theta, axis=1)

    # Handle angle wrapping
    dtheta = np.unwrap(theta, axis=1)
    dtheta = np.gradient(dtheta, axis=1)

    # Smoothing
    dr_s     = gaussian_filter(dr, sigma=sigma)
    dtheta_s = gaussian_filter(dtheta, sigma=sigma)

    return dr_s, dtheta_s, r, theta

def pol2cart(dr, dtheta, r, theta):
    """
    Converts smoothed polar velocities to Cartesian velocities.
    All arrays shape: (n_traj, n_points)
    """
    u = dr * np.cos(theta) - r * dtheta * np.sin(theta)
    v = dr * np.sin(theta) + r * dtheta * np.cos(theta)
    return u, v

def create_field(x, y, u, v, grid_size=100, method='linear', z_lim=5):
    """
    Interpolate velocity field to a regular grid.
    Inputs: x,y,u,v all (n_samples,) or (n_traj, n_points) -- flatten them first.
    Returns: xi, yi, ui, vi: all (grid_size, grid_size) arrays.
    """
    x_flat = x.flatten()
    y_flat = y.flatten()
    u_flat = u.flatten()
    v_flat = v.flatten()

    # xi, yi = np.meshgrid(
    #     np.linspace(np.min(x_flat), np.max(x_flat), grid_size),
    #     np.linspace(np.min(y_flat), np.max(y_flat), grid_size),
    # )

    x_min, x_max = np.min(x_flat)-1, np.max(x_flat)+1
    y_min, y_max = np.min(y_flat)-1, np.max(y_flat)+1

    if z_lim is 0:
        z_min = np.min((x_min, y_min))
        z_max = np.min((x_max, y_max))
    else:
        z_min = -z_lim
        z_max = z_lim

    xi, yi = np.meshgrid(np.linspace(z_min, z_max, grid_size),
                         np.linspace(z_min, z_max, grid_size))


    ui = griddata((x_flat, y_flat), u_flat, (xi, yi), method=method, fill_value=np.nan)
    vi = griddata((x_flat, y_flat), v_flat, (xi, yi), method=method, fill_value=np.nan)

    # Fill nans with nearest
    mask = np.isnan(ui)
    if np.any(mask):
        ui[mask] = griddata((x_flat, y_flat), u_flat, (xi, yi), method='nearest')[mask]
        vi[mask] = griddata((x_flat, y_flat), v_flat, (xi, yi), method='nearest')[mask]

    return xi, yi, ui, vi

def plot_field(xi, yi, ui, vi, ax=None, density=1.0, show_cbar=0):
    speed = np.sqrt(ui**2 + vi**2)
    if ax is None:
        fig, ax = plt.subplots(figsize=(5,5))
    # Normalize for coloring
    import matplotlib as mpl
    vmin, vmax = np.nanpercentile(speed, [5, 95])
    norm = mpl.colors.Normalize(vmin, vmax)
    strm = ax.streamplot(xi, yi, ui, vi, density=density, color=speed, cmap='coolwarm', norm=norm)
    if show_cbar:
        plt.colorbar(strm.lines, ax=ax, label='Speed')
    ax.set_aspect('equal')
    ax.set_xlabel('x')
    ax.set_ylabel('y')
    return ax
#+end_src

#+RESULTS:

#+begin_src ipython
n_comp = 3
i_mouse = 3
print(options['mice'][i_mouse])
# X = np.swapaxes(pca_list[i_mouse], 1, 2)
# y_labels = y_trials[i_mouse]
# print(X.shape, y.shape)
#+end_src

#+RESULTS:
: JawsM15

#+begin_src ipython
idx = (y_cv.tasks=='DPA') & (y_cv.mouse==options['mice'][i_mouse])

X_delay = X[idx].copy()
X_delay = X_delay[:, :2, options['bins_DELAY']]

x = X_delay[:,0,:]
y = X_delay[:,1,:]

# 1. Polar smoothing
dr_s, dtheta_s, r, theta = polar_velocities(x, y, sigma=3)

# 2. Map back to Cartesian velocities
u, v = pol2cart(dr_s, dtheta_s, r, theta)

# 3. Interpolate to grid
xi, yi, ui, vi = create_field(x, y, u, v, grid_size=12, method='linear', z_lim=10)

# 4. Plot
fig, ax = plt.subplots(figsize=(width, width))
plot_field(xi, yi, ui, vi, ax=ax)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_138.png]]

#+begin_src ipython
idx = (y_cv.tasks=='DPA') & (y_cv.test_odor==0) & (y_cv.mouse==options['mice'][i_mouse])

X_delay = X[idx].copy()
X_delay = X_delay[:, :2, options['bins_TEST'][0]:66]

x = X_delay[:,0,:]
y = X_delay[:,1,:]

# 1. Polar smoothing
dr_s, dtheta_s, r, theta = polar_velocities(x, y, sigma=3)

# 2. Map back to Cartesian velocities
u, v = pol2cart(dr_s, dtheta_s, r, theta)

# 3. Interpolate to grid
xi, yi, ui, vi = create_field(x, y, u, v, grid_size=32, method='linear', z_lim=5)

# 4. Plot
fig, ax = plt.subplots(figsize=(width, width))
plot_field(xi, yi, ui, vi, ax=ax)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_139.png]]

#+begin_src ipython
idx = (y_cv.tasks=='DPA') & (y_cv.sample_odor==0) #& (y_cv.mouse==options['mice'][i_mouse])

X_delay = X[idx].copy()
X_delay = X_delay[:, :2, options['bins_STIM']]

x = X_delay[:,0,:]
y = X_delay[:,1,:]

# 1. Polar smoothing
dr_s, dtheta_s, r, theta = polar_velocities(x, y, sigma=5)

# 2. Map back to Cartesian velocities
u, v = pol2cart(dr_s, dtheta_s, r, theta)

# 3. Interpolate to grid
xi, yi, ui, vi = create_field(x, y, u, v, grid_size=12, method='linear', z_lim=6)

# 4. Plot
fig, ax = plt.subplots(figsize=(width, width))
plot_field(xi, yi, ui, vi, ax=ax)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_138.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

* Cross validated PCA
** Model

#+begin_src ipython
from sklearn.model_selection import KFold
from sklearn.decomposition import PCA

def cross_val_avg_pca(X, y, n_splits, n_comp, epoch, condition):
    kf = KFold(n_splits, shuffle=True)
    pca = PCA(n_components=n_comp)
    scaler = StandardScaler(axis=0)

    X_folds, y_folds = [], []
    w_folds, evr_folds = [], []
    for train_idx, test_idx in kf.split(X):
        X_train, X_test = X[train_idx], X[test_idx]

        X_train = scaler.fit_transform(X_train)
        X_avg = cv_avg_cond(X_train, y.iloc[train_idx].copy(), condition)

        X_flat = X_avg[..., epoch].transpose(0, 2, 1).reshape(-1, X_avg.shape[1])

        X_mean = np.nanmean(X_flat, 0, keepdims=1)
        X_cent = (X_flat - X_mean)

        pca.fit(X_cent)
        w_folds.append(pca.components_)
        evr_folds.append(pca.explained_variance_ratio_)

        X_test = scaler.transform(X_test)

        X_flat = X_test.transpose(0, 2, 1).reshape(-1, X_test.shape[1])
        X_cent = (X_flat - X_mean)

        X_pca = pca.transform(X_cent).reshape(X_test.shape[0], X_test.shape[-1], -1)

        X_folds.append(X_pca[0])
        y_folds.append(y_folds.append(y.iloc[test_idx].copy()))

    X_folds = np.array(X_folds)
    y_folds = pd.concat(y_folds)

    w_folds = np.array(w_folds)
    evr_folds = np.array(evr_folds)

    return X_folds, y_folds, w_folds, evr_folds
#+end_src

#+RESULTS:

#+begin_src ipython
import numpy as np
import itertools
from functools import reduce
import operator

def cv_avg_cond(X, y, condition='odor_pair'):
    # Ensure condition is a list
    if isinstance(condition, str):
        condition = [condition]

    # Find unique values for each condition
    unique_vals = [y[c].unique() for c in condition]

    X_avg = []
    combos = list(itertools.product(*unique_vals))
    for combo in combos:
        # Build boolean mask for all conditions
        idx = reduce(operator.and_, [(y[c]==v) for c,v in zip(condition, combo)])
        if idx.any():
            X_avg.append(np.mean(X[idx], axis=0))

    return np.array(X_avg)
#+end_src

#+RESULTS:

#+begin_src ipython
from src.common.get_data import get_X_y_days, get_X_y_S1_S2, get_X_y_mice
from scipy.signal import detrend

options['tasks'] = ['DPA']
options['task'] = 'DPA'
options['trials'] = ''

options['mice'] = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23', 'ACCM03', 'ACCM04']
# options['mice'] = ['JawsM01', 'JawsM06']
# options['mice'] = ['JawsM15']

options['epochs'] = ['POST_GNG']
# options['epochs'] = ['TASK']
epoch = options['bins_' + options['epochs'][0]]

condition = ['sample_odor', 'choice']
condition = 'odor_pair'

w_mouse, evr_mouse = [], []
X_mouse, y_mouse = [], []

for mouse in options['mice']:
    options['mouse'] = mouse
    options = set_options(**options)
    print(mouse)

    w_day, evr_day = [], []
    X_day, y_day = [], []
    for day in options['days']:
        options['day'] = day

        X_days, y_days = get_X_y_days(**options)
        X, y = get_X_y_S1_S2(X_days, y_days, **options)
        print(X.shape, y.shape)

        X_cv, y_cv, w_cv, evr_cv = cross_val_avg_pca(X, y, X.shape[0], 5, epoch, condition)
        y_cv['learning'] = day

        X_day.append(X_cv)
        y_day.append(y_cv)

        w_day.append(w_cv)
        evr_day.append(evr_cv)

    X_day = np.concatenate(X_day, axis=0)
    w_day = np.concatenate(w_day, axis=0)
    evr_day = np.concatenate(evr_day, axis=0)

    print(X_day.shape, w_day.shape, evr_day.shape)

    X_mouse.append(X_day)

    y_day = pd.concat(y_day)
    y_day['mouse'] = mouse
    y_mouse.append(y_day)

    w_mouse.append(w_day)
    evr_mouse.append(evr_day)
#+end_src

#+RESULTS:
#+begin_example
JawsM01
first [1 2 3] [1. 0.]
(96, 184, 84) (96, 14)
last [4] [1. 0.]
(32, 184, 84) (32, 14)
(128, 84, 5) (128, 5, 184) (128, 5)
JawsM06
first [1 2 3] [1. 0.]
(96, 201, 84) (96, 14)
last [4 5 6] [1. 0.]
(96, 201, 84) (96, 14)
(192, 84, 5) (192, 5, 201) (192, 5)
JawsM12
first [1 2 3] [1. 0.]
(96, 423, 84) (96, 14)
last [4 5] [1. 0.]
(64, 423, 84) (64, 14)
(160, 84, 5) (160, 5, 423) (160, 5)
JawsM15
first [1. 2. 3.] [0. 1.]
(96, 693, 84) (96, 15)
last [4. 5. 6.] [1. 0.]
(96, 693, 84) (96, 15)
(192, 84, 5) (192, 5, 693) (192, 5)
JawsM18
first [1. 2. 3.] [1. 0.]
(96, 444, 84) (96, 15)
last [4. 5. 6.] [1. 0.]
(96, 444, 84) (96, 15)
(192, 84, 5) (192, 5, 444) (192, 5)
ChRM04
first [1. 2. 3.] [1. 0.]
(96, 668, 84) (96, 15)
last [4. 5. 6.] [1. 0.]
(96, 668, 84) (96, 15)
(192, 84, 5) (192, 5, 668) (192, 5)
ChRM23
first [1 2 3] [1. 0.]
(96, 232, 84) (96, 14)
last [4 5] [1. 0.]
(64, 232, 84) (64, 14)
(160, 84, 5) (160, 5, 232) (160, 5)
ACCM03
first [1. 2. 3.] [1. 0.]
(192, 361, 84) (192, 15)
last [4. 5.] [1. 0.]
(128, 361, 84) (128, 15)
(320, 84, 5) (320, 5, 361) (320, 5)
ACCM04
first [1. 2. 3.] [1. 0.]
(192, 113, 84) (192, 15)
last [4. 5.] [1. 0.]
(128, 113, 84) (128, 15)
(320, 84, 5) (320, 5, 113) (320, 5)
#+end_example

#+begin_src ipython
X_mouse = np.array(X_mouse, dtype=object)
y_mouse = pd.concat(y_mouse)
print(X_mouse.shape, y_mouse.shape)

w_mouse = np.array(w_mouse, dtype=object)
evr_mouse = np.array(evr_mouse, dtype=object)
print(w_mouse.shape, evr_mouse.shape)
#+end_src

#+RESULTS:
: (9,) (1856, 16)
: (9,) (9,)

#+begin_src ipython
pkl_save(X_mouse, 'traj_cv_dpa', path="../data/pca")
pkl_save(y_mouse, 'y_cv_dpa', path="../data/pca")
pkl_save(w_mouse, 'w_cv_dpa', path="../data/pca")
pkl_save(evr_mouse, 'evr_cv_dpa', path="../data/pca")
#+end_src

#+RESULTS:
: saving to ../data/pca/traj_cv_dpa.pkl
: saving to ../data/pca/y_cv_dpa.pkl
: saving to ../data/pca/w_cv_dpa.pkl
: saving to ../data/pca/evr_cv_dpa.pkl

#+begin_src ipython
X = np.concatenate(X_mouse, 0)
print(X_mouse[0].shape, X_mouse[1].shape, X_all.shape)
print(w_mouse[0].shape, w_mouse[1].shape, X_all.shape)
y = y_mouse
print(X.shape, y.shape, w.shape)
#+end_src

#+RESULTS:
: (128, 84, 5) (192, 84, 5) (5568, 84, 5)
: (128, 5, 184) (192, 5, 201) (5568, 84, 5)
: (1856, 84, 5) (1856, 16) (3319, 5)

#+begin_src ipython
i_mouse = 0
i_day = 1

X = X_mouse[i_mouse]
w = w_mouse[i_mouse]

y = y_mouse[(y_mouse.mouse==options['mice'][i_mouse])]
print(X.shape, y.shape, w.shape)
#+end_src

#+RESULTS:
: (128, 84, 5) (128, 16) (128, 5, 184)

#+begin_src ipython
idx = (y.learning==options['days'][i_day])
print(idx.sum())

y = y[idx]

X_pca = np.array(X[idx], dtype=float)
X = np.swapaxes(X_pca, 1, 2)

# w = w[idx]
# w = np.mean(w_mouse[i_mouse][idx], 0, dtype=float) * 100

print(X.shape, y.shape, w.shape, y.tasks.unique(), y.response.unique())
#+end_src

#+RESULTS:
: 32
: (32, 5, 84) (32, 16) (128, 5, 184) ['DPA'] ['correct_hit' 'correct_rej' 'incorrect_fa']

#+begin_src ipython

#+end_src

#+RESULTS:

** Trajectories

#+begin_src ipython
n_comp = 3
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height),)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
xtime = np.linspace(0, 14, 84)

for i in range(4):
    mask = (y.odor_pair==i)
    X_sel = X[mask]

    X_avg = np.mean(X_sel, 0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = np.std(X_sel, 0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_72.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = y.tasks.unique()
xtime = np.linspace(0, 14, 84)

for i in range(len(y.tasks.unique())):
    mask = (y.tasks==y.tasks.unique()[i]) # & (y.odor_pair==3)
    X_sel = X[mask]

    X_avg = X_sel.mean(0)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=0)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_73.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['A', 'B']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.sample_odor.values==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_74.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['unpair', 'pair']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.pair==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_75.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#4daf4a"]

pair = ['nolick', 'lick']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.choice==i)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_76.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#4daf4a", "#ffae19"]

pair = ['C', 'D']
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.test_odor==i)
    X_sel = X[mask]
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_77.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = (X[(y.odor_pair==i)].mean(0))[:, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_78.png]]

#+begin_src ipython

#+end_src

#+RESULTS:

** Embeddings

#+begin_src ipython
z_lim=5
import cmocean
cmap=cmocean.cm.phase

theta = np.arctan2(w[0], w[1]) * 180 / np.pi
idx = np.argsort(theta)

theta_norm = (theta+ 360) % (360)

counts, bins, patches = plt.hist(theta_norm, bins='auto', range=(0, 360), density=1)

bin_centers = 0.5*(bins[:-1] + bins[1:])
colors = [cmap(center/(360)) for center in bin_centers]

for patch, color in zip(patches, colors):
    patch.set_facecolor(color)

plt.xlabel('Neuron Loc (°)')
plt.ylabel('Density')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_77.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, gaussian_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

size = 0.1

for k in range(n_comp):
    sc = ax[k].scatter(theta[idx], w[k][idx], alpha=0.5, c=theta_norm[idx], cmap=cmap)
    ax[k].plot(theta[idx], gaussian_filter1d(w[k][idx], int(size*w.shape[1]), mode='wrap'), 'k')
    ax[k].axhline(0, ls='--', color='k')
    ax[k].set_ylabel('Weights PC %d' % (k+1))
    ax[k].set_xlabel('Neuron Loc (°)')
    ax[k].set_ylim([-z_lim, z_lim])

ax[-1].set_ylim([-z_lim/2, z_lim/2])
plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_78.png]]

#+begin_src ipython
nbins = 30
theta_bins = np.linspace(0, 360, nbins+1)
theta_digitized = np.digitize(theta_norm, theta_bins) - 1

# For each bin, average w[0], w[1], and w[2]
w_binned = np.zeros((3, nbins))
for i in range(nbins):
    mask = theta_digitized == i
    for j in range(3):
        w_binned[j, i] = np.mean(w[j][mask]) if np.any(mask) else np.nan

w_smooth = gaussian_filter1d(w_binned, sigma=3, axis=1, mode='wrap')
#+end_src

#+RESULTS:

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height))

for i, ax in enumerate(axs):
    ax.plot(theta_plot * 180 / np.pi, w_smooth[i], lw=2)
    ax.axhline(0, ls='--', color='k')
    ax.set_ylabel('Weights PC %d' % (i+1))
    ax.set_xlabel('Neuron Loc (°)')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_80.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

# Compute bin centers in degrees and radians
bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)  # for polar plots

fig, axs = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width), sharey=1)

# PC1 vs PC2
axs[0].plot(w_smooth[0], w_smooth[1], 'k-')
axs[0].set_xlabel('PC 1')
axs[0].set_ylabel('PC 2')

# PC1 vs PC3
axs[1].plot(w_smooth[0], w_smooth[2], 'k-')
axs[1].set_xlabel('PC 1')
axs[1].set_ylabel('PC 3')

# PC2 vs PC3
axs[2].plot(w_smooth[1], w_smooth[2], 'k-')
axs[2].set_xlabel('PC 2')
axs[2].set_ylabel('PC 3')

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_81.png]]

#+begin_src ipython
import matplotlib.pyplot as plt
from numpy import deg2rad

bin_centers = 0.5 * (theta_bins[:-1] + theta_bins[1:])
theta_plot = deg2rad(bin_centers)

fig, axs = plt.subplots(1, 3, subplot_kw={'polar': True}, figsize=(n_comp*width, width))

for i, ax in enumerate(axs):
    ax.plot(theta_plot, w_smooth[i], lw=2)

plt.tight_layout()
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_82.png]]

#+begin_src ipython
from scipy.ndimage import gaussian_filter1d, uniform_filter1d
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, width))

ax[0].scatter(w[0][idx], w[1][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[0].plot(gaussian_filter1d(w[0][idx], int(size*w.shape[1]), mode='wrap'), gaussian_filter1d(w[1][idx], int(size*w.shape[1]), mode='wrap'), 'k')

ax[0].set_xlabel('PC 1')
ax[0].set_ylabel('PC 2')

ax[1].scatter(w[0][idx], w[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[1].plot(gaussian_filter1d(w[0][idx], int(size*w.shape[1]), mode='wrap'), gaussian_filter1d(w[2][idx], int(size*w.shape[1]), mode='wrap'), 'k')
ax[1].set_xlabel('PC 1')
ax[1].set_ylabel('PC 3')

sc = ax[2].scatter(w[1][idx], w[2][idx], c=theta_norm[idx], cmap=cmap, alpha=0.5)
ax[2].plot(gaussian_filter1d(w[1][idx], int(size*w.shape[1]), mode='wrap'), gaussian_filter1d(w[2][idx], int(size*w.shape[1]), mode='wrap'), 'k')
ax[2].set_xlabel('PC 2')
ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].set_xlim(-z_lim, z_lim)
    ax[k].set_ylim(-z_lim, z_lim)

plt.colorbar(sc, ax=ax[-1], label='Angle (°)')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_83.png]]

#+begin_src ipython
fig = plt.figure()
ax = fig.add_subplot(111, projection='3d')

ax.plot(gaussian_filter1d(w[0][idx], int(size*w.shape[1]), mode='wrap'),
           gaussian_filter1d(w[1][idx], int(size*w.shape[1]), mode='wrap'),
           gaussian_filter1d(w[2][idx], int(size*w.shape[1]), mode='wrap'),
           rasterized=1, color='k')


sc = ax.scatter(w[0][idx],
                w[1][idx],
                w[2][idx],
                c=theta_norm[idx], cmap=cmap,
                rasterized=1, alpha=0.5)

ax.tick_params(axis='both', which='major', labelsize=12)  # change both x and y (and z in 3D)
ax.tick_params(axis='z', which='major', labelsize=12)     # for the z-axis specifically

ax.set_xlabel('PC 1', fontsize=12)
ax.set_ylabel('PC 2', fontsize=12)
ax.set_zlabel('PC 3', fontsize=12)

ax.set_xlim([-z_lim, z_lim])
ax.set_ylim([-z_lim, z_lim])
ax.set_zlim([-z_lim/10, z_lim/10])

ax.grid(False)

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_84.png]]


#+begin_src ipython

#+end_src

#+RESULTS:
