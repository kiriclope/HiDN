
* adeaf

#+begin_src ipython
from src.common.get_data import get_X_y_days, get_X_y_S1_S2, get_X_y_mice

options['reload'] = 0
options['epochs'] = ['all']
options['days'] = 'all'

X_mouse = []
X_all = []
y_all = []

options['mice'] = ['JawsM01', 'JawsM06', 'JawsM12', 'JawsM15', 'JawsM18', 'ChRM04', 'ChRM23', 'ACCM03', 'ACCM04']

for mouse in options['mice']:
    options['mouse'] = mouse
    options = set_options(**options)

    X_day = []
    for day in options['days'][3:]:

        options['day'] = day

        X_days, y_days = get_X_y_days(**options)
        y_days = y_days.reset_index()
        y_days['idx'] = y_days['index'].copy()

        X, y = get_X_y_S1_S2(X_days, y_days, **options)
        y_labels = y.copy()

        if options['epochs'][0] == 'all':
            X_task = X.copy()
        else:
            X_task = X[..., options['bins_' + options['epochs'][0]]]

        X_avg = []
        for i in range(4):
            if options['task']!='all':
                idx = (y_labels.odor_pair==i)

                if idx.mean()>0:
                    X_avg.append(np.mean(X_task[idx], 0))
                else:
                    for k in range(len(y_labels.tasks.unique())):
                        task = y_labels.tasks.unique()[k]
                        idx = (y_labels.odor_pair==i) & (y_labels.tasks==task)

                        if 'Dual' in y_labels.tasks.unique()[k]:
                            idx = (y_labels.odor_pair==i) & (y_labels.tasks==task)

                        if idx.mean()>0:
                            X_avg.append(np.mean(X_task[idx], 0))

        X_avg = np.array(X_avg)
        X_mean = np.mean(X_task, 0)[np.newaxis]
        X_avg -= X_mean

        X_day.append(X_avg)

    X_mouse.append(np.nanmean(X_day, 0))
#+end_src

#+RESULTS:

* CCA

#+begin_src ipython
from mvlearn.embed import MCCA
mcca = MCCA(n_components=3, regs='oas')

X= np.array(X_mouse[0])

X_reshaped = np.transpose(X, (0,1,3,2))
X_reshaped = X_reshaped.reshape(X.shape[0], X.shape[1]*X.shape[3], X.shape[2])

X_cca = mcca.fit_transform(X_reshaped)
X_reshaped = X_cca.reshape(X.shape[0], X.shape[1], X.shape[3], 3)
X_reshaped = np.transpose(X_reshaped, (0, 1, 3, 2))

pcs = np.array(mcca.loadings_)
#+end_src

#+RESULTS:
: (7, 5, 3)

#+begin_src ipython
i_mouse = 3
z_lim = 10

X = X_reshaped[i_mouse]
y = y_mouse[0][i_mouse]

print(options['mice'][i_mouse], 'day', options['days'][i_day], 'X', X.shape, 'y', y.shape, 'pcs', pcs.shape)
#+end_src

#+RESULTS:
: JawsM15 day last X (96, 3, 84) y (96, 18) pcs (7, 5, 3)

*** Trajectories

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ['#332288', '#88CCEE', '#117733', '#44AA99']

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(4):
    mask = (y.odor_pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)

        ax[k].legend(fontsize=12, frameon=0, loc='best')
plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_34.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['A', 'B']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.sample_odor==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_35.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['unpair', 'pair']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.pair==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_36.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=n_comp, figsize=(n_comp*width, height), sharey=1)

color = ["#377eb8", "#984ea3", "#4daf4a", "#ffae19"]

pair = ['nolick', 'lick']
task = 'DPA'
xtime = np.linspace(0, 14, 84)

for i in range(2):
    mask = (y.choice==i) & (y.tasks==task)
    X_sel = X[mask]          # Subselect rows
    X_avg = X_sel.mean(0)    # Mean over trials/samples, shape: (n_comp, n_time)
    X_sem = X_sel.std(0) / np.sqrt(X_sel.shape[0])  # SEM

    for k in range(n_comp):
        y_avg = X_avg[k]
        y_sem = X_sem[k]
        ax[k].plot(xtime, y_avg, color=color[i], label=pair[i])
        ax[k].fill_between(xtime, y_avg-y_sem, y_avg+y_sem, color=color[i], alpha=0.2)
        ax[k].axhline(0, ls='--', color='k')
        ax[k].set_xlabel('Time')
        ax[k].set_ylabel('PC %d' % (k+1))
        add_vlines(ax[k], if_dpa=1)
        ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_37.png]]

#+begin_src ipython
fig, ax = plt.subplots(nrows=1, ncols=3, figsize=(3*width, height))

pair = ['AC', 'AD', 'BD', 'BC']
task = 'DPA'
color = ['#332288', '#88CCEE', '#117733', '#44AA99']

for i in range(4):
    X_avg = (X[(y.odor_pair==i) & (y.tasks==task)].mean(0))[:, :66]

    # X_avg = X[(y.odor_pair==i) & (y.tasks==task)]
    # idx = np.random.randint(X_avg.shape[0])
    # X_avg = X_avg[idx, :66]

    ax[0].plot(X_avg[0], X_avg[1], color=color[i], label=pair[i])
    ax[0].set_xlabel('PC 1')
    ax[0].set_ylabel('PC 2')

    ax[1].plot(X_avg[0], X_avg[2], color=color[i], label=pair[i])
    ax[1].set_xlabel('PC 1')
    ax[1].set_ylabel('PC 3')

    ax[2].plot(X_avg[1], X_avg[2], color=color[i], label=pair[i])
    ax[2].set_xlabel('PC 2')
    ax[2].set_ylabel('PC 3')

for k in range(3):
    ax[k].legend(fontsize=12, frameon=0, loc='best')

plt.show()
#+end_src

#+RESULTS:
[[file:./figures/overlaps/figure_38.png]]

#+begin_src ipython

#+end_src

#+RESULTS:
